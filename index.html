<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Celestial Dyeworks Studio Manager</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            line-height: 1.5;
        }
        .bg-gray-50 { background-color: #f9fafb; }
        .bg-white { background-color: #ffffff; }
        .bg-gray-100 { background-color: #f3f4f6; }
        .bg-gray-200 { background-color: #e5e7eb; }
        .bg-purple-50 { background-color: #faf5ff; }
        .bg-purple-600 { background-color: #9333ea; }
        .bg-purple-700 { background-color: #7e22ce; }
        .bg-blue-50 { background-color: #eff6ff; }
        .bg-green-50 { background-color: #f0fdf4; }
        .bg-yellow-50 { background-color: #fefce8; }
        .bg-red-50 { background-color: #fef2f2; }
        
        .text-white { color: #ffffff; }
        .text-gray-300 { color: #d1d5db; }
        .text-gray-400 { color: #9ca3af; }
        .text-gray-500 { color: #6b7280; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-700 { color: #374151; }
        .text-gray-900 { color: #111827; }
        .text-purple-100 { color: #f3e8ff; }
        .text-purple-600 { color: #9333ea; }
        .text-purple-700 { color: #7e22ce; }
        .text-blue-600 { color: #2563eb; }
        .text-blue-700 { color: #1d4ed8; }
        .text-green-600 { color: #16a34a; }
        .text-green-700 { color: #15803d; }
        .text-yellow-600 { color: #ca8a04; }
        .text-yellow-700 { color: #a16207; }
        .text-red-600 { color: #dc2626; }
        .text-red-800 { color: #991b1b; }
        
        .min-h-screen { min-height: 100vh; }
        .container { max-width: 1280px; margin: 0 auto; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .py-6 { padding-top: 1.5rem; padding-bottom: 1.5rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        .py-12 { padding-top: 3rem; padding-bottom: 3rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        
        .pt-2 { padding-top: 0.5rem; }
        .pt-4 { padding-top: 1rem; }
        .pb-2 { padding-bottom: 0.5rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mr-3 { margin-right: 0.75rem; }
        .ml-auto { margin-left: auto; }
        
        .space-y-2 > * + * { margin-top: 0.5rem; }
        .space-y-3 > * + * { margin-top: 0.75rem; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .space-y-6 > * + * { margin-top: 1.5rem; }
        .space-x-1 > * + * { margin-left: 0.25rem; }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        
        .flex { display: flex; }
        .grid { display: grid; }
        .items-center { align-items: center; }
        .items-start { align-items: flex-start; }
        .justify-between { justify-content: space-between; }
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        
        .rounded { border-radius: 0.25rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-full { border-radius: 9999px; }
        
        .border { border: 1px solid #e5e7eb; }
        .border-b { border-bottom: 1px solid #e5e7eb; }
        .border-2 { border: 2px solid #e5e7eb; }
        .border-l-4 { border-left: 4px solid; }
        
        .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
        .text-4xl { font-size: 2.25rem; line-height: 2.5rem; }
        
        .w-full { width: 100%; }
        .w-6 { width: 1.5rem; }
        .w-12 { width: 3rem; }
        .w-20 { width: 5rem; }
        .w-24 { width: 6rem; }
        .h-6 { height: 1.5rem; }
        .h-12 { height: 3rem; }
        
        .overflow-hidden { overflow: hidden; }
        .overflow-x-auto { overflow-x: auto; }
        .whitespace-nowrap { white-space: nowrap; }
        .whitespace-pre-line { white-space: pre-line; }
        .capitalize { text-transform: capitalize; }
        .uppercase { text-transform: uppercase; }
        
        .sticky { position: sticky; }
        .top-0 { top: 0; }
        .z-10 { z-index: 10; }
        
        .divide-y > * + * { border-top: 1px solid #e5e7eb; }
        
        button, input, select, textarea {
            font-family: inherit;
            font-size: 100%;
        }
        
        button {
            cursor: pointer;
            border: none;
            background: none;
        }
        
        input, select, textarea {
            outline: none;
            border: 1px solid #d1d5db;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #9333ea;
            ring: 2px solid #9333ea;
            box-shadow: 0 0 0 2px rgba(147, 51, 234, 0.2);
        }
        
        .hover\:bg-purple-700:hover { background-color: #7e22ce; }
        .hover\:bg-gray-50:hover { background-color: #f9fafb; }
        .hover\:bg-gray-300:hover { background-color: #d1d5db; }
        .hover\:bg-red-50:hover { background-color: #fef2f2; }
        .hover\:bg-blue-50:hover { background-color: #eff6ff; }
        .hover\:text-gray-900:hover { color: #111827; }
        .hover\:text-blue-800:hover { color: #1e40af; }
        .hover\:text-red-800:hover { color: #991b1b; }
        .hover\:text-purple-700:hover { color: #7e22ce; }
        
        .transition-colors { transition-property: color, background-color, border-color; transition-duration: 150ms; }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .tab-active { border-bottom: 3px solid #667eea; color: #667eea; }
        .status-dyeing { background-color: #fef3c7; color: #92400e; }
        .status-drying { background-color: #dbeafe; color: #1e40af; }
        .status-ready { background-color: #d1fae5; color: #065f46; }
        .status-sold { background-color: #e5e7eb; color: #374151; }
        .low-stock { background-color: #fee2e2; border-left: 4px solid #ef4444; }
        
        .flex-1 { flex: 1; }
        
        @media (min-width: 768px) {
            .md\:grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
            .md\:grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
            .md\:grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
            .md\:flex { display: flex; }
        }
        
        @media (min-width: 1024px) {
            .lg\:grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
            .lg\:grid-cols-6 { grid-template-columns: repeat(6, 1fr); }
        }
        
        table { border-collapse: collapse; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Initialize Supabase client
        const supabase = window.supabase.createClient(
            'https://hqjuyceebdujenrrtoth.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxanV5Y2VlYmR1amVucnJ0b3RoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NjI0MzgsImV4cCI6MjA4NjEzODQzOH0.JH7smh8TBaQ8QdLvFrqsuR2v04N2Ks-JZnydXOWVu2w'
        );

        // Fixed user ID (no authentication required)
        const USER_ID = 'default-user';

        // Storage utilities using Supabase
        const StorageManager = {
            async get(key) {
                try {
                    if (key === 'settings') {
                        const { data, error } = await supabase
                            .from('settings')
                            .select('settings_data')
                            .eq('user_id', USER_ID)
                            .maybeSingle();
                        
                        if (error) {
                            console.error(`Error fetching settings:`, error);
                            return null;
                        }
                        return data?.settings_data || null;
                    }

                    const { data, error } = await supabase
                        .from(key)
                        .select('*')
                        .eq('user_id', USER_ID);
                    
                    if (error) {
                        console.error(`Error fetching ${key}:`, error.message, error);
                        return [];
                    }
                    
                    console.log(`Fetched ${key}:`, data?.length || 0, 'items');
                    return data || [];
                } catch (error) {
                    console.error(`Exception in get(${key}):`, error);
                    return key === 'settings' ? null : [];
                }
            },
            
            async set(key, value) {
                try {
                    if (key === 'settings') {
                        const { data, error } = await supabase
                            .from('settings')
                            .upsert({ 
                                user_id: USER_ID, 
                                settings_data: value 
                            }, {
                                onConflict: 'user_id'
                            });
                        
                        if (error) {
                            console.error(`Error saving settings:`, error);
                            return false;
                        }
                        console.log('Settings saved successfully');
                        return true;
                    }

                    // For arrays of data
                    if (Array.isArray(value)) {
                        // COMPREHENSIVE SAFETY CHECK: Prevent accidental data loss
                        // Don't allow saving empty arrays if data currently exists in the table
                        if (value.length === 0) {
                            // Check if we're trying to clear a table that has data
                            const { data: existingData } = await supabase
                                .from(key)
                                .select('id')
                                .eq('user_id', USER_ID)
                                .limit(1);
                            
                            if (existingData && existingData.length > 0) {
                                console.error(`ðŸš¨ BLOCKED: Attempted to clear ${key} table with existing data`);
                                const confirmed = confirm(
                                    `âš ï¸ WARNING: You are about to DELETE ALL ${existingData.length > 0 ? 'EXISTING' : ''} data from "${key}"!\n\n` +
                                    `This will permanently remove all your ${key}.\n\n` +
                                    `Are you absolutely sure you want to continue?`
                                );
                                
                                if (!confirmed) {
                                    console.log(`User cancelled clearing ${key} table`);
                                    return false;
                                }
                                console.log(`User confirmed clearing ${key} table`);
                            }
                        }
                        
                        // Delete existing items
                        const { error: deleteError } = await supabase
                            .from(key)
                            .delete()
                            .eq('user_id', USER_ID);
                        
                        if (deleteError) {
                            console.error(`Error deleting old ${key}:`, deleteError);
                        }
                        
                        // Insert new items
                        if (value.length > 0) {
                            // Clean data: convert empty strings to null for numeric fields
                            const cleanedItems = value.map(item => {
                                const cleaned = { ...item, user_id: USER_ID };
                                
                                // Convert empty strings to null for numeric fields
                                Object.keys(cleaned).forEach(key => {
                                    if (cleaned[key] === '' || cleaned[key] === undefined) {
                                        cleaned[key] = null;
                                    }
                                });
                                
                                return cleaned;
                            });
                            
                            const { data, error } = await supabase
                                .from(key)
                                .insert(cleanedItems);
                            
                            if (error) {
                                console.error(`Error inserting ${key}:`, error.message, error);
                                console.log('Attempted to insert:', cleanedItems[0]);
                                return false;
                            }
                            console.log(`Saved ${value.length} items to ${key}`);
                        }
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error(`Exception in set(${key}):`, error);
                    return false;
                }
            }
        };

        function YarnDyeManager() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [recipes, setRecipes] = useState([]);
            const [inventory, setInventory] = useState([]);
            const [batches, setBatches] = useState([]);
            const [sales, setSales] = useState([]);
            const [dyeSessions, setDyeSessions] = useState([]);
            const [kits, setKits] = useState([]);
            const [loading, setLoading] = useState(true);
            const [settings, setSettings] = useState({
                colorTypes: ['tonal', 'variegated', 'speckled'],
                inventoryCategories: ['dye', 'yarn base', 'chemical', 'tool', 'ball band', 'other'],
                units: ['ml', 'g', 'oz', 'lb', 'tsp', 'tbsp'],
                suppliers: ['Dharma', 'Wool2Dye4', 'Amazon'],
                yarnBaseMappings: [
                    { supplierName: 'W2D4 Merino Bulky SW', myName: 'Luna Bulky' },
                    { supplierName: 'W2D4 SW DK', myName: 'Luna DK' }
                ],
                sizeMappings: [
                    { grams: 100, name: 'Full skein' },
                    { grams: 50, name: 'Half skein' },
                    { grams: 20, name: 'Mini skein' },
                    { grams: 10, name: 'Micro skein' }
                ]
            });

            // Load data on mount
            useEffect(() => {
                loadAllData();
            }, []);

            const loadAllData = async () => {
                setLoading(true);
                try {
                    console.log('Loading data from Supabase...');
                    const recipesData = await StorageManager.get('recipes');
                    const inventoryData = await StorageManager.get('inventory');
                    const batchesData = await StorageManager.get('batches');
                    const salesData = await StorageManager.get('sales');
                    const dyeSessionsData = await StorageManager.get('dye_sessions');
                    const kitsData = await StorageManager.get('kits');
                    const settingsData = await StorageManager.get('settings');
                    
                    console.log('Loaded recipes:', recipesData);
                    console.log('Loaded inventory:', inventoryData);
                    console.log('Loaded batches:', batchesData);
                    
                    setRecipes(recipesData || []);
                    setInventory(inventoryData || []);
                    setBatches(batchesData || []);
                    setSales(salesData || []);
                    setDyeSessions(dyeSessionsData || []);
                    setKits(kitsData || []);
                    setSettings(settingsData || {
                        colorTypes: ['tonal', 'variegated', 'speckled'],
                        inventoryCategories: ['dye', 'yarn base', 'chemical', 'tool', 'ball band', 'other'],
                        units: ['ml', 'g', 'oz', 'lb', 'tsp', 'tbsp'],
                        suppliers: ['Dharma', 'Wool2Dye4', 'Amazon'],
                        yarnBaseMappings: [
                            { supplierName: 'W2D4 Merino Bulky SW', myName: 'Luna Bulky' },
                            { supplierName: 'W2D4 SW DK', myName: 'Luna DK' }
                        ],
                        sizeMappings: [
                            { grams: 100, name: 'Full skein' },
                            { grams: 50, name: 'Half skein' },
                            { grams: 20, name: 'Mini skein' },
                            { grams: 10, name: 'Micro skein' }
                        ]
                    });
                    console.log('Data loaded successfully!');
                } catch (error) {
                    console.error('Error loading data:', error);
                }
                setLoading(false);
            };

            const saveRecipes = async (newRecipes) => {
                setRecipes(newRecipes);
                await StorageManager.set('recipes', newRecipes);
            };

            const saveInventory = async (newInventory) => {
                // Safety check - don't save if inventory is empty and we previously had items
                if ((!newInventory || newInventory.length === 0) && inventory.length > 0) {
                    console.warn('Prevented saving empty inventory - this might be an error');
                    if (!confirm('Warning: You are about to clear all inventory. Are you sure?')) {
                        return;
                    }
                }
                setInventory(newInventory);
                await StorageManager.set('inventory', newInventory);
            };

            const saveBatches = async (newBatches) => {
                if (newBatches.length === 0 && batches.length > 0) {
                    console.warn('Attempting to save empty batches when batches exist - this will be blocked by StorageManager');
                }
                setBatches(newBatches);
                await StorageManager.set('batches', newBatches);
            };

            const saveSales = async (newSales) => {
                setSales(newSales);
                await StorageManager.set('sales', newSales);
            };

            const saveDyeSessions = async (newSessions) => {
                setDyeSessions(newSessions);
                await StorageManager.set('dye_sessions', newSessions);
            };

            const saveKits = async (newKits) => {
                setKits(newKits);
                await StorageManager.set('kits', newKits);
            };

            const saveSettings = async (newSettings) => {
                setSettings(newSettings);
                await StorageManager.set('settings', newSettings);
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
                            <p className="text-gray-600">Loading your studio...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <header className="gradient-bg text-white shadow-lg">
                        <div className="container mx-auto px-4 py-6">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h1 className="text-3xl font-bold">ðŸ§¶ Celestial Dyeworks Studio Manager</h1>
                                    <p className="text-purple-100 mt-1">Professional dyeing business management</p>
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => {
                                            const data = {
                                                recipes,
                                                inventory,
                                                batches,
                                                sales,
                                                dyeSessions,
                                                kits,
                                                settings,
                                                exportDate: new Date().toISOString()
                                            };
                                            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                                            const url = URL.createObjectURL(blob);
                                            const a = document.createElement('a');
                                            a.href = url;
                                            a.download = `celestial-dyeworks-backup-${new Date().toISOString().split('T')[0]}.json`;
                                            a.click();
                                            URL.revokeObjectURL(url);
                                        }}
                                        className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors font-medium"
                                    >
                                        ðŸ’¾ Export Backup
                                    </button>
                                    <button
                                        onClick={() => {
                                            const input = document.createElement('input');
                                            input.type = 'file';
                                            input.accept = '.json';
                                            input.onchange = async (e) => {
                                                const file = e.target.files[0];
                                                if (file) {
                                                    try {
                                                        const text = await file.text();
                                                        const data = JSON.parse(text);
                                                        if (confirm(`Import backup from ${data.exportDate || 'unknown date'}?\n\nThis will restore:\n- ${data.recipes?.length || 0} recipes\n- ${data.inventory?.length || 0} inventory items\n- ${data.batches?.length || 0} batches\n- ${data.sales?.length || 0} sales\n- ${data.dyeSessions?.length || 0} dye sessions\n- ${data.kits?.length || 0} kits`)) {
                                                            // First update state
                                                            setRecipes(data.recipes || []);
                                                            setInventory(data.inventory || []);
                                                            setBatches(data.batches || []);
                                                            setSales(data.sales || []);
                                                            setDyeSessions(data.dyeSessions || []);
                                                            setKits(data.kits || []);
                                                            if (data.settings) setSettings(data.settings);
                                                            
                                                            // Then save to database and WAIT for all to complete
                                                            console.log('Saving backup data to database...');
                                                            await Promise.all([
                                                                StorageManager.set('recipes', data.recipes || []),
                                                                StorageManager.set('inventory', data.inventory || []),
                                                                StorageManager.set('batches', data.batches || []),
                                                                StorageManager.set('sales', data.sales || []),
                                                                StorageManager.set('dye_sessions', data.dyeSessions || []),
                                                                StorageManager.set('kits', data.kits || []),
                                                                StorageManager.set('settings', data.settings || settings)
                                                            ]);
                                                            
                                                            console.log('All data saved successfully!');
                                                            alert('Backup restored successfully! Page will reload.');
                                                            
                                                            // Wait a bit more to ensure database commits
                                                            setTimeout(() => {
                                                                window.location.reload();
                                                            }, 500);
                                                        }
                                                    } catch (error) {
                                                        console.error('Import error:', error);
                                                        alert('Error reading backup file: ' + error.message);
                                                    }
                                                }
                                            };
                                            input.click();
                                        }}
                                        className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium"
                                    >
                                        ðŸ“¥ Import Backup
                                    </button>
                                    <button
                                        onClick={async () => {
                                            if (!confirm('Restore batches directly from Supabase?\n\nThis will reload batch data from the database without importing a file.')) return;
                                            
                                            try {
                                                const batchesData = await StorageManager.get('batches');
                                                console.log('Loaded batches from database:', batchesData);
                                                setBatches(batchesData || []);
                                                alert(`Restored ${batchesData?.length || 0} batches from database`);
                                            } catch (error) {
                                                alert('Error loading batches: ' + error.message);
                                            }
                                        }}
                                        className="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors font-medium text-sm"
                                    >
                                        ðŸ”„ Reload Batches
                                    </button>
                                    <button
                                        onClick={() => {
                                            sessionStorage.removeItem('dyestudio_auth');
                                            window.location.reload();
                                        }}
                                        className="bg-white text-purple-700 px-4 py-2 rounded-lg hover:bg-purple-50 transition-colors font-medium border border-purple-200"
                                    >
                                        Sign Out
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Navigation */}
                    <nav className="bg-white shadow-sm border-b sticky top-0 z-10">
                        <div className="container mx-auto px-4">
                            <div className="flex space-x-1 overflow-x-auto">
                                {[
                                    { id: 'dashboard', label: 'ðŸ“Š Dashboard', icon: 'ðŸ“Š' },
                                    { id: 'recipes', label: 'ðŸ“ Recipes', icon: 'ðŸ“' },
                                    { id: 'kits', label: 'ðŸŽ Kits', icon: 'ðŸŽ' },
                                    { id: 'sessions', label: 'ðŸŽ¨ Dye Sessions', icon: 'ðŸŽ¨' },
                                    { id: 'upnext', label: 'â–¶ï¸ Up Next', icon: 'â–¶ï¸' },
                                    { id: 'inventory', label: 'ðŸ“¦ Inventory', icon: 'ðŸ“¦' },
                                    { id: 'pipeline', label: 'ðŸ”„ Pipeline', icon: 'ðŸ”„' },
                                    { id: 'sales', label: 'ðŸ’° Sales', icon: 'ðŸ’°' },
                                    { id: 'settings', label: 'âš™ï¸ Settings', icon: 'âš™ï¸' }
                                ].map(tab => (
                                    <button
                                        key={tab.id}
                                        onClick={() => setActiveTab(tab.id)}
                                        className={`px-6 py-4 font-medium whitespace-nowrap transition-colors ${
                                            activeTab === tab.id 
                                                ? 'tab-active' 
                                                : 'text-gray-600 hover:text-gray-900'
                                        }`}
                                    >
                                        {tab.label}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </nav>

                    {/* Main Content */}
                    <main className="container mx-auto px-4 py-8">
                        {activeTab === 'dashboard' && (
                            <Dashboard 
                                recipes={recipes} 
                                inventory={inventory} 
                                batches={batches} 
                                sales={sales} 
                            />
                        )}
                        {activeTab === 'recipes' && (
                            <Recipes recipes={recipes} saveRecipes={saveRecipes} settings={settings} inventory={inventory} />
                        )}
                        {activeTab === 'kits' && (
                            <Kits kits={kits} saveKits={saveKits} recipes={recipes} />
                        )}
                        {activeTab === 'sessions' && (
                            <DyeSessions 
                                dyeSessions={dyeSessions} 
                                saveDyeSessions={saveDyeSessions}
                                recipes={recipes}
                                inventory={inventory}
                                settings={settings}
                            />
                        )}
                        {activeTab === 'upnext' && (
                            <UpNext 
                                dyeSessions={dyeSessions}
                                saveDyeSessions={saveDyeSessions}
                                batches={batches}
                                saveBatches={saveBatches}
                                inventory={inventory}
                                saveInventory={saveInventory}
                                recipes={recipes}
                                settings={settings}
                            />
                        )}
                        {activeTab === 'inventory' && (
                            <Inventory inventory={inventory} saveInventory={saveInventory} settings={settings} />
                        )}
                        {activeTab === 'pipeline' && (
                            <Pipeline 
                                batches={batches} 
                                saveBatches={saveBatches} 
                                recipes={recipes}
                                inventory={inventory}
                                saveInventory={saveInventory}
                                settings={settings}
                            />
                        )}
                        {activeTab === 'sales' && (
                            <Sales 
                                sales={sales} 
                                saveSales={saveSales} 
                                batches={batches}
                                saveBatches={saveBatches}
                            />
                        )}
                        {activeTab === 'settings' && (
                            <Settings 
                                settings={settings}
                                saveSettings={saveSettings}
                                inventory={inventory}
                            />
                        )}
                    </main>
                </div>
            );
        }

        // Dashboard Component
        function Dashboard({ recipes, inventory, batches, sales }) {
            const activeBatches = batches.filter(b => b.status !== 'sold').length;
            const lowStock = inventory.filter(i => 
                i.lowStockThreshold != null && 
                i.lowStockThreshold !== '' && 
                i.quantity <= i.lowStockThreshold
            ).length;
            const totalRevenue = sales.reduce((sum, s) => sum + parseFloat(s.amount || 0), 0);
            const thisMonthSales = sales.filter(s => {
                const saleDate = new Date(s.date);
                const now = new Date();
                return saleDate.getMonth() === now.getMonth() && saleDate.getFullYear() === now.getFullYear();
            }).length;
            
            // Calculate total profit from sold batches
            const soldBatches = batches.filter(b => b.status === 'sold');
            const totalProfit = soldBatches.reduce((sum, b) => sum + (b.profit || 0), 0);
            const totalCost = soldBatches.reduce((sum, b) => sum + (b.totalCost || 0), 0);
            const avgProfitMargin = totalCost > 0 ? ((totalProfit / totalCost) * 100) : 0;

            const statusCounts = batches.reduce((acc, batch) => {
                acc[batch.status] = (acc[batch.status] || 0) + 1;
                return acc;
            }, {});

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold text-gray-900">Studio Overview</h2>
                    
                    {/* Stats Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <StatCard 
                            title="Total Recipes" 
                            value={recipes.length} 
                            icon="ðŸ“"
                            color="purple"
                        />
                        <StatCard 
                            title="Active Batches" 
                            value={activeBatches} 
                            icon="ðŸ”„"
                            color="blue"
                        />
                        <StatCard 
                            title="Low Stock Items" 
                            value={lowStock} 
                            icon="âš ï¸"
                            color={lowStock > 0 ? "red" : "green"}
                        />
                        <StatCard 
                            title="Total Revenue" 
                            value={`$${totalRevenue.toFixed(2)}`} 
                            icon="ðŸ’°"
                            color="green"
                        />
                        <StatCard 
                            title="Total Profit" 
                            value={`$${totalProfit.toFixed(2)}`} 
                            icon="ðŸ“ˆ"
                            color={totalProfit >= 0 ? "green" : "red"}
                        />
                        <StatCard 
                            title="Avg Margin" 
                            value={`${avgProfitMargin.toFixed(1)}%`} 
                            icon="ðŸ“Š"
                            color={avgProfitMargin >= 30 ? "green" : avgProfitMargin >= 15 ? "yellow" : "red"}
                        />
                    </div>

                    {/* Pipeline Status */}
                    <div className="bg-white rounded-lg card-shadow p-6">
                        <h3 className="text-lg font-semibold mb-4">Production Pipeline</h3>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div className="text-center p-4 bg-yellow-50 rounded-lg">
                                <div className="text-3xl font-bold text-yellow-700">{statusCounts.dyeing || 0}</div>
                                <div className="text-sm text-yellow-600 mt-1">Dyeing</div>
                            </div>
                            <div className="text-center p-4 bg-blue-50 rounded-lg">
                                <div className="text-3xl font-bold text-blue-700">{statusCounts.drying || 0}</div>
                                <div className="text-sm text-blue-600 mt-1">Drying</div>
                            </div>
                            <div className="text-center p-4 bg-green-50 rounded-lg">
                                <div className="text-3xl font-bold text-green-700">{statusCounts.ready || 0}</div>
                                <div className="text-sm text-green-600 mt-1">Ready for Labels</div>
                            </div>
                            <div className="text-center p-4 bg-gray-50 rounded-lg">
                                <div className="text-3xl font-bold text-gray-700">{statusCounts.sold || 0}</div>
                                <div className="text-sm text-gray-600 mt-1">Sold</div>
                            </div>
                        </div>
                    </div>

                    {/* Recent Activity */}
                    <div className="grid md:grid-cols-2 gap-6">
                        <div className="bg-white rounded-lg card-shadow p-6">
                            <h3 className="text-lg font-semibold mb-4">Recent Sales</h3>
                            {sales.length > 0 ? (
                                <div className="space-y-2">
                                    {sales.slice(-5).reverse().map((sale, idx) => (
                                        <div key={idx} className="flex justify-between items-center py-2 border-b">
                                            <div>
                                                <div className="font-medium">{sale.colorway}</div>
                                                <div className="text-sm text-gray-500">{sale.customer}</div>
                                            </div>
                                            <div className="text-right">
                                                <div className="font-semibold text-green-600">${sale.amount}</div>
                                                <div className="text-xs text-gray-400">{new Date(sale.date).toLocaleDateString()}</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <p className="text-gray-400 text-center py-8">No sales yet</p>
                            )}
                        </div>

                        <div className="bg-white rounded-lg card-shadow p-6">
                            <h3 className="text-lg font-semibold mb-4">Low Stock Alert</h3>
                            {lowStock > 0 ? (
                                <div className="space-y-2">
                                    {inventory.filter(i => 
                                        i.lowStockThreshold != null && 
                                        i.lowStockThreshold !== '' && 
                                        i.quantity <= i.lowStockThreshold
                                    ).map((item, idx) => (
                                        <div key={idx} className="flex justify-between items-center p-3 bg-red-50 rounded border-l-4 border-red-500">
                                            <div>
                                                <div className="font-medium">{item.name}</div>
                                                <div className="text-sm text-gray-600">{item.category}</div>
                                            </div>
                                            <div className="text-right">
                                                <div className="font-semibold text-red-600">{item.quantity} {item.unit}</div>
                                                <div className="text-xs text-gray-500">Min: {item.lowStockThreshold}</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <p className="text-gray-400 text-center py-8">All items well stocked âœ“</p>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function StatCard({ title, value, icon, color }) {
            const colors = {
                purple: 'bg-purple-50 text-purple-700',
                blue: 'bg-blue-50 text-blue-700',
                green: 'bg-green-50 text-green-700',
                red: 'bg-red-50 text-red-700'
            };

            return (
                <div className="bg-white rounded-lg card-shadow p-6">
                    <div className="flex items-center justify-between">
                        <div>
                            <p className="text-sm text-gray-600 mb-1">{title}</p>
                            <p className="text-3xl font-bold text-gray-900">{value}</p>
                        </div>
                        <div className={`text-4xl p-3 rounded-lg ${colors[color]}`}>
                            {icon}
                        </div>
                    </div>
                </div>
            );
        }

        // Recipes Component
        function Recipes({ recipes, saveRecipes, settings, inventory }) {
            const [showForm, setShowForm] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [filterColorType, setFilterColorType] = useState('all');
            const [sortBy, setSortBy] = useState('name');
            const fileInputRef = React.useRef(null);
            const [formData, setFormData] = useState({
                name: '',
                yarnWeight: '',
                colorType: 'tonal',
                ingredients: [{ name: '', amount: '', unit: 'ml' }],
                // Variegated specific fields
                colorSolutions: [{ 
                    name: '', 
                    dyes: [{ name: '', amount: '', unit: 'g' }], 
                    targetMl: '' 
                }],
                totalMl: '2400',
                stockSolutionPercent: '1',
                citricAcidPerBatch: '1',
                instructions: '',
                photo: '',
                notes: '',
                created: new Date().toISOString()
            });

            // Get list of dyes from inventory
            const availableDyes = inventory
                .filter(item => item.category === 'dye')
                .map(item => item.name)
                .sort();

            const handleSubmit = (e) => {
                e.preventDefault();
                if (editingId) {
                    saveRecipes(recipes.map(r => r.id === editingId ? { ...formData, id: editingId } : r));
                } else {
                    saveRecipes([...recipes, { ...formData, id: Date.now() }]);
                }
                resetForm();
            };

            const resetForm = () => {
                setFormData({
                    name: '',
                    yarnWeight: '',
                    colorType: 'tonal',
                    ingredients: [{ name: '', amount: '', unit: 'ml' }],
                    colorSolutions: [{ 
                        name: '', 
                        dyes: [{ name: '', amount: '', unit: 'g' }], 
                        targetMl: '' 
                    }],
                    totalMl: '2400',
                    stockSolutionPercent: '1',
                    citricAcidPerBatch: '1',
                    instructions: '',
                    photo: '',
                    notes: '',
                    created: new Date().toISOString()
                });
                if (fileInputRef.current) {
                    fileInputRef.current.value = '';
                }
                setShowForm(false);
                setEditingId(null);
            };

            const editRecipe = (recipe) => {
                setFormData(recipe);
                setEditingId(recipe.id);
                setShowForm(true);
                // Clear file input when editing (photo is already in formData)
                if (fileInputRef.current) {
                    fileInputRef.current.value = '';
                }
            };

            const deleteRecipe = (id) => {
                if (confirm('Delete this recipe?')) {
                    saveRecipes(recipes.filter(r => r.id !== id));
                }
            };

            const addIngredient = () => {
                setFormData({
                    ...formData,
                    ingredients: [...formData.ingredients, { name: '', amount: '', unit: 'ml' }]
                });
            };

            const updateIngredient = (index, field, value) => {
                const newIngredients = [...formData.ingredients];
                newIngredients[index][field] = value;
                setFormData({ ...formData, ingredients: newIngredients });
            };

            const removeIngredient = (index) => {
                setFormData({
                    ...formData,
                    ingredients: formData.ingredients.filter((_, i) => i !== index)
                });
            };

            const handlePhotoUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        // Create an image element to compress
                        const img = new Image();
                        img.onload = () => {
                            // Create canvas for compression
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // Set max dimensions (smaller = less storage)
                            const MAX_WIDTH = 800;
                            const MAX_HEIGHT = 800;
                            
                            let width = img.width;
                            let height = img.height;
                            
                            // Calculate new dimensions while maintaining aspect ratio
                            if (width > height) {
                                if (width > MAX_WIDTH) {
                                    height = Math.round((height * MAX_WIDTH) / width);
                                    width = MAX_WIDTH;
                                }
                            } else {
                                if (height > MAX_HEIGHT) {
                                    width = Math.round((width * MAX_HEIGHT) / height);
                                    height = MAX_HEIGHT;
                                }
                            }
                            
                            // Set canvas dimensions and draw image
                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Convert to compressed JPEG (0.7 quality = good balance)
                            const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                            
                            setFormData({ ...formData, photo: compressedDataUrl });
                        };
                        img.src = reader.result;
                    };
                    reader.readAsDataURL(file);
                }
            };

            const filteredRecipes = recipes
                .filter(r => r.name.toLowerCase().includes(searchTerm.toLowerCase()))
                .filter(r => filterColorType === 'all' || r.colorType === filterColorType)
                .sort((a, b) => {
                    if (sortBy === 'name') {
                        return a.name.localeCompare(b.name);
                    } else if (sortBy === 'colorType') {
                        return a.colorType.localeCompare(b.colorType);
                    }
                    return 0;
                });

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-900">Dye Recipes</h2>
                            <p className="text-sm text-gray-600 mt-1">{recipes.length} recipe{recipes.length !== 1 ? 's' : ''} total</p>
                        </div>
                        <button
                            onClick={() => setShowForm(!showForm)}
                            className="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors font-medium"
                        >
                            {showForm ? 'âœ• Cancel' : '+ New Recipe'}
                        </button>
                    </div>

                    {/* Search */}
                    <input
                        type="text"
                        placeholder="ðŸ” Search recipes..."
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    />

                    {/* Filter and Sort */}
                    <div className="grid md:grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Filter by Color Type</label>
                            <select
                                value={filterColorType}
                                onChange={(e) => setFilterColorType(e.target.value)}
                                className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                            >
                                <option value="all">All Color Types</option>
                                {(settings.colorTypes || ['tonal', 'variegated', 'speckled']).map(type => (
                                    <option key={type} value={type} className="capitalize">{type}</option>
                                ))}
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Sort by</label>
                            <select
                                value={sortBy}
                                onChange={(e) => setSortBy(e.target.value)}
                                className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                            >
                                <option value="name">Colorway Name</option>
                                <option value="colorType">Color Type</option>
                            </select>
                        </div>
                    </div>

                    {/* Form */}
                    {showForm && (
                        <div className="bg-white rounded-lg card-shadow p-6">
                            <h3 className="text-xl font-semibold mb-4">{editingId ? 'Edit Recipe' : 'New Recipe'}</h3>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div className="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Colorway Name *</label>
                                        <input
                                            type="text"
                                            required
                                            value={formData.name}
                                            onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                            placeholder="e.g., Deep Ocean Blue"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Yarn Weight (grams) *</label>
                                        <input
                                            type="number"
                                            step="0.1"
                                            required
                                            value={formData.yarnWeight}
                                            onChange={(e) => setFormData({ ...formData, yarnWeight: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                            placeholder="e.g., 100"
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Color Type *</label>
                                    <select
                                        required
                                        value={formData.colorType}
                                        onChange={(e) => setFormData({ ...formData, colorType: e.target.value })}
                                        className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                    >
                                        {(settings.colorTypes || ['tonal', 'variegated', 'speckled']).map(type => (
                                            <option key={type} value={type} className="capitalize">{type}</option>
                                        ))}
                                    </select>
                                </div>

                                {/* Tonal/Speckled Ingredients */}
                                {formData.colorType !== 'variegated' && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Ingredients</label>
                                        {formData.ingredients.map((ing, idx) => (
                                            <div key={idx} className="flex gap-2 mb-2">
                                                <div className="flex-1">
                                                    <input
                                                        type="text"
                                                        placeholder="Dye/ingredient name"
                                                        value={ing.name}
                                                        onChange={(e) => updateIngredient(idx, 'name', e.target.value)}
                                                        className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                        list={`dye-list-${idx}`}
                                                    />
                                                    <datalist id={`dye-list-${idx}`}>
                                                        {availableDyes.map((dye, i) => (
                                                            <option key={i} value={dye} />
                                                        ))}
                                                    </datalist>
                                                </div>
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    placeholder="Amount"
                                                    value={ing.amount}
                                                    onChange={(e) => updateIngredient(idx, 'amount', e.target.value)}
                                                    className="w-24 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                />
                                                <select
                                                    value={ing.unit}
                                                    onChange={(e) => updateIngredient(idx, 'unit', e.target.value)}
                                                    className="w-20 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                >
                                                    <option value="ml">ml</option>
                                                    <option value="g">g</option>
                                                    <option value="tsp">tsp</option>
                                                    <option value="tbsp">tbsp</option>
                                                </select>
                                                <button
                                                    type="button"
                                                    onClick={() => removeIngredient(idx)}
                                                    className="text-red-600 hover:text-red-800 px-2"
                                                >
                                                    âœ•
                                                </button>
                                            </div>
                                        ))}
                                        <button
                                            type="button"
                                            onClick={addIngredient}
                                            className="text-purple-600 hover:text-purple-700 text-sm font-medium"
                                        >
                                            + Add Ingredient
                                        </button>
                                    </div>
                                )}

                                {/* Variegated Color Solutions */}
                                {formData.colorType === 'variegated' && (
                                    <div className="space-y-4">
                                        <div className="grid md:grid-cols-3 gap-4 bg-purple-50 p-4 rounded-lg">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Total ml Needed</label>
                                                <input
                                                    type="number"
                                                    value={formData.totalMl}
                                                    onChange={(e) => setFormData({ ...formData, totalMl: e.target.value })}
                                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                    placeholder="2400"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Stock Solution %</label>
                                                <input
                                                    type="number"
                                                    step="0.1"
                                                    value={formData.stockSolutionPercent}
                                                    onChange={(e) => setFormData({ ...formData, stockSolutionPercent: e.target.value })}
                                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                    placeholder="1"
                                                />
                                                <p className="text-xs text-gray-500 mt-1">1g powder per 100ml water</p>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Citric Acid (tbsp)</label>
                                                <input
                                                    type="number"
                                                    step="0.1"
                                                    value={formData.citricAcidPerBatch}
                                                    onChange={(e) => setFormData({ ...formData, citricAcidPerBatch: e.target.value })}
                                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                    placeholder="1"
                                                />
                                                <p className="text-xs text-gray-500 mt-1">Per 300g yarn</p>
                                            </div>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Color Solutions</label>
                                            {formData.colorSolutions.map((solution, sIdx) => (
                                                <div key={sIdx} className="border-2 border-purple-200 rounded-lg p-4 mb-4">
                                                    <div className="flex justify-between items-center mb-3">
                                                        <h4 className="font-medium text-gray-900">Solution {sIdx + 1}</h4>
                                                        <button
                                                            type="button"
                                                            onClick={() => {
                                                                const newSolutions = formData.colorSolutions.filter((_, i) => i !== sIdx);
                                                                setFormData({ ...formData, colorSolutions: newSolutions });
                                                            }}
                                                            className="text-red-600 hover:text-red-800"
                                                        >
                                                            Remove Solution
                                                        </button>
                                                    </div>
                                                    
                                                    <div className="grid md:grid-cols-2 gap-3 mb-3">
                                                        <div>
                                                            <label className="block text-xs font-medium text-gray-700 mb-1">Solution Name</label>
                                                            <input
                                                                type="text"
                                                                placeholder="e.g., Purple Mix"
                                                                value={solution.name}
                                                                onChange={(e) => {
                                                                    const newSolutions = [...formData.colorSolutions];
                                                                    newSolutions[sIdx].name = e.target.value;
                                                                    setFormData({ ...formData, colorSolutions: newSolutions });
                                                                }}
                                                                className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                            />
                                                        </div>
                                                        <div>
                                                            <label className="block text-xs font-medium text-gray-700 mb-1">Target ml</label>
                                                            <input
                                                                type="number"
                                                                placeholder="800"
                                                                value={solution.targetMl}
                                                                onChange={(e) => {
                                                                    const newSolutions = [...formData.colorSolutions];
                                                                    newSolutions[sIdx].targetMl = e.target.value;
                                                                    setFormData({ ...formData, colorSolutions: newSolutions });
                                                                }}
                                                                className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                            />
                                                        </div>
                                                    </div>

                                                    <label className="block text-xs font-medium text-gray-700 mb-1">Dye Ingredients</label>
                                                    {solution.dyes.map((dye, dIdx) => (
                                                        <div key={dIdx} className="flex gap-2 mb-2">
                                                            <div className="flex-1">
                                                                <input
                                                                    type="text"
                                                                    placeholder="Dye name"
                                                                    value={dye.name}
                                                                    onChange={(e) => {
                                                                        const newSolutions = [...formData.colorSolutions];
                                                                        newSolutions[sIdx].dyes[dIdx].name = e.target.value;
                                                                        setFormData({ ...formData, colorSolutions: newSolutions });
                                                                    }}
                                                                    className="w-full px-2 py-1 border rounded focus:ring-2 focus:ring-purple-500 text-sm"
                                                                    list={`var-dye-list-${sIdx}-${dIdx}`}
                                                                />
                                                                <datalist id={`var-dye-list-${sIdx}-${dIdx}`}>
                                                                    {availableDyes.map((d, i) => (
                                                                        <option key={i} value={d} />
                                                                    ))}
                                                                </datalist>
                                                            </div>
                                                            <input
                                                                type="number"
                                                                step="0.01"
                                                                placeholder="Amount"
                                                                value={dye.amount}
                                                                onChange={(e) => {
                                                                    const newSolutions = [...formData.colorSolutions];
                                                                    newSolutions[sIdx].dyes[dIdx].amount = e.target.value;
                                                                    setFormData({ ...formData, colorSolutions: newSolutions });
                                                                }}
                                                                className="w-20 px-2 py-1 border rounded focus:ring-2 focus:ring-purple-500 text-sm"
                                                            />
                                                            <select
                                                                value={dye.unit}
                                                                onChange={(e) => {
                                                                    const newSolutions = [...formData.colorSolutions];
                                                                    newSolutions[sIdx].dyes[dIdx].unit = e.target.value;
                                                                    setFormData({ ...formData, colorSolutions: newSolutions });
                                                                }}
                                                                className="w-16 px-2 py-1 border rounded focus:ring-2 focus:ring-purple-500 text-sm"
                                                            >
                                                                <option value="g">g</option>
                                                                <option value="ml">ml</option>
                                                            </select>
                                                            <button
                                                                type="button"
                                                                onClick={() => {
                                                                    const newSolutions = [...formData.colorSolutions];
                                                                    newSolutions[sIdx].dyes = newSolutions[sIdx].dyes.filter((_, i) => i !== dIdx);
                                                                    setFormData({ ...formData, colorSolutions: newSolutions });
                                                                }}
                                                                className="text-red-600 hover:text-red-800 px-1 text-sm"
                                                            >
                                                                âœ•
                                                            </button>
                                                        </div>
                                                    ))}
                                                    <button
                                                        type="button"
                                                        onClick={() => {
                                                            const newSolutions = [...formData.colorSolutions];
                                                            newSolutions[sIdx].dyes.push({ name: '', amount: '', unit: 'g' });
                                                            setFormData({ ...formData, colorSolutions: newSolutions });
                                                        }}
                                                        className="text-purple-600 hover:text-purple-700 text-xs font-medium"
                                                    >
                                                        + Add Dye
                                                    </button>
                                                </div>
                                            ))}
                                            <button
                                                type="button"
                                                onClick={() => {
                                                    setFormData({
                                                        ...formData,
                                                        colorSolutions: [
                                                            ...formData.colorSolutions,
                                                            { name: '', dyes: [{ name: '', amount: '', unit: 'g' }], targetMl: '' }
                                                        ]
                                                    });
                                                }}
                                                className="text-purple-600 hover:text-purple-700 text-sm font-medium"
                                            >
                                                + Add Color Solution
                                            </button>
                                        </div>
                                    </div>
                                )}

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Instructions</label>
                                    <textarea
                                        value={formData.instructions}
                                        onChange={(e) => setFormData({ ...formData, instructions: e.target.value })}
                                        rows="4"
                                        className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                        placeholder="Step-by-step dyeing process..."
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Photo</label>
                                    <input
                                        ref={fileInputRef}
                                        type="file"
                                        accept="image/*"
                                        onChange={handlePhotoUpload}
                                        className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                    />
                                    {formData.photo && (
                                        <div className="mt-2">
                                            <img src={formData.photo} alt="Recipe preview" className="rounded-lg" style={{maxWidth: '200px', maxHeight: '200px'}} />
                                            <button
                                                type="button"
                                                onClick={() => {
                                                    setFormData({ ...formData, photo: '' });
                                                    if (fileInputRef.current) {
                                                        fileInputRef.current.value = '';
                                                    }
                                                }}
                                                className="text-sm text-red-600 hover:text-red-800 mt-1"
                                            >
                                                Remove photo
                                            </button>
                                        </div>
                                    )}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                                    <textarea
                                        value={formData.notes}
                                        onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                                        rows="3"
                                        className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                        placeholder="Any tips, variations, or notes about this colorway..."
                                    />
                                </div>

                                <div className="flex gap-3 pt-4">
                                    <button
                                        type="submit"
                                        className="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors font-medium"
                                    >
                                        {editingId ? 'Update Recipe' : 'Save Recipe'}
                                    </button>
                                    <button
                                        type="button"
                                        onClick={resetForm}
                                        className="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-300 transition-colors font-medium"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}

                    {/* Recipe List */}
                    <div className="grid md:grid-cols-3 lg:grid-cols-4 gap-4">
                        {filteredRecipes.map(recipe => {
                            const [expanded, setExpanded] = React.useState(false);
                            
                            return (
                            <div key={recipe.id} className="bg-white rounded-lg card-shadow p-4">
                                <div className="flex justify-between items-start mb-3">
                                    <div className="flex-1">
                                        <h3 className="text-lg font-semibold text-gray-900">{recipe.name}</h3>
                                        <div className="flex gap-2 items-center mt-1">
                                            <p className="text-xs text-purple-600 font-medium">{recipe.yarnWeight}g</p>
                                            <span className="text-gray-400">â€¢</span>
                                            <p className="text-xs text-gray-600 capitalize">{recipe.colorType}</p>
                                        </div>
                                    </div>
                                    <div className="flex gap-1 flex-shrink-0">
                                        <button
                                            onClick={() => editRecipe(recipe)}
                                            className="text-blue-600 hover:bg-blue-50 px-2 py-1 rounded text-sm"
                                        >
                                            âœï¸
                                        </button>
                                        <button
                                            onClick={() => deleteRecipe(recipe.id)}
                                            className="text-red-600 hover:bg-red-50 px-2 py-1 rounded text-sm"
                                        >
                                            ðŸ—‘ï¸
                                        </button>
                                    </div>
                                </div>

                                {recipe.photo && (
                                    <div className="mb-3">
                                        <img src={recipe.photo} alt={recipe.name} className="rounded-lg w-full" style={{maxHeight: '200px', objectFit: 'cover'}} />
                                    </div>
                                )}

                                {/* Collapsible Ingredients & Instructions */}
                                <button
                                    onClick={() => setExpanded(!expanded)}
                                    className="w-full text-left text-sm text-purple-600 hover:text-purple-700 font-medium mt-2 mb-2"
                                >
                                    {expanded ? 'â–¼' : 'â–¶'} {expanded ? 'Hide' : 'Show'} Details
                                </button>

                                {expanded && (
                                    <div className="space-y-3 text-xs">
                                        {recipe.colorType === 'variegated' && recipe.colorSolutions ? (
                                            <div>
                                                <h4 className="font-medium text-gray-700 mb-1">Color Solutions:</h4>
                                                {recipe.colorSolutions.map((solution, idx) => (
                                                    <div key={idx} className="mb-2 pl-2 border-l-2 border-purple-300">
                                                        <div className="font-medium text-purple-700">{solution.name || `Solution ${idx + 1}`}</div>
                                                        <div className="text-gray-600">Target: {solution.targetMl}ml</div>
                                                        <ul className="space-y-1 mt-1">
                                                            {solution.dyes.map((dye, dIdx) => (
                                                                <li key={dIdx} className="text-gray-600">
                                                                    {dye.name}: {dye.amount}{dye.unit}
                                                                </li>
                                                            ))}
                                                        </ul>
                                                    </div>
                                                ))}
                                                {recipe.totalMl && <div className="text-gray-600 mt-2">Total: {recipe.totalMl}ml</div>}
                                            </div>
                                        ) : recipe.ingredients && (
                                            <div>
                                                <h4 className="font-medium text-gray-700 mb-1">Ingredients:</h4>
                                                <ul className="space-y-1">
                                                    {recipe.ingredients.map((ing, idx) => (
                                                        <li key={idx} className="text-gray-600">
                                                            {ing.name}: {ing.amount}{ing.unit}
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )}

                                        {recipe.instructions && (
                                            <div>
                                                <h4 className="font-medium text-gray-700 mb-1">Instructions:</h4>
                                                <p className="text-gray-600 whitespace-pre-line">{recipe.instructions}</p>
                                            </div>
                                        )}

                                        {recipe.notes && (
                                            <div>
                                                <h4 className="font-medium text-gray-700 mb-1">Notes:</h4>
                                                <p className="text-gray-600">{recipe.notes}</p>
                                            </div>
                                        )}
                                    </div>
                                )}

                                <p className="text-xs text-gray-400 pt-2">
                                    Created: {new Date(recipe.created).toLocaleDateString()}
                                </p>
                            </div>
                            );
                        })}
                    </div>

                    {filteredRecipes.length === 0 && (
                        <div className="text-center py-12 text-gray-400">
                            <p className="text-xl mb-2">ðŸ“</p>
                            <p>No recipes yet. Create your first dye recipe!</p>
                        </div>
                    )}
                </div>
            );
        }

        // Kits Component
        function Kits({ kits, saveKits, recipes }) {
            const [showForm, setShowForm] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [formData, setFormData] = useState({
                name: '',
                description: '',
                colors: [{ colorwayName: '', quantity: 1 }],
                notes: ''
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                if (editingId) {
                    saveKits(kits.map(k => k.id === editingId ? { ...formData, id: editingId } : k));
                } else {
                    saveKits([...kits, { ...formData, id: Date.now(), created: new Date().toISOString() }]);
                }
                resetForm();
            };

            const resetForm = () => {
                setFormData({
                    name: '',
                    description: '',
                    colors: [{ colorwayName: '', quantity: 1 }],
                    notes: ''
                });
                setShowForm(false);
                setEditingId(null);
            };

            const editKit = (kit) => {
                setFormData(kit);
                setEditingId(kit.id);
                setShowForm(true);
            };

            const deleteKit = (id) => {
                if (confirm('Delete this kit?')) {
                    saveKits(kits.filter(k => k.id !== id));
                }
            };

            const addColor = () => {
                setFormData({
                    ...formData,
                    colors: [...formData.colors, { colorwayName: '', quantity: 1 }]
                });
            };

            const updateColor = (index, field, value) => {
                const newColors = [...formData.colors];
                newColors[index][field] = value;
                setFormData({ ...formData, colors: newColors });
            };

            const removeColor = (index) => {
                setFormData({
                    ...formData,
                    colors: formData.colors.filter((_, i) => i !== index)
                });
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-900">Yarn Kits</h2>
                            <p className="text-sm text-gray-600 mt-1">{kits.length} kit{kits.length !== 1 ? 's' : ''} total</p>
                        </div>
                        <button
                            onClick={() => setShowForm(!showForm)}
                            className="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors font-medium"
                        >
                            {showForm ? 'âœ• Cancel' : '+ New Kit'}
                        </button>
                    </div>

                    {/* Form */}
                    {showForm && (
                        <div className="bg-white rounded-lg card-shadow p-6">
                            <h3 className="text-xl font-semibold mb-4">{editingId ? 'Edit Kit' : 'New Kit'}</h3>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div className="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Kit Name *</label>
                                        <input
                                            type="text"
                                            required
                                            value={formData.name}
                                            onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                            placeholder="e.g., Autumn Kit"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                        <input
                                            type="text"
                                            value={formData.description}
                                            onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                            placeholder="e.g., Fall-themed colorways"
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Colors in Kit</label>
                                    {formData.colors.map((color, idx) => (
                                        <div key={idx} className="flex gap-2 mb-2">
                                            <div className="flex-1">
                                                <input
                                                    type="text"
                                                    placeholder="Colorway name"
                                                    value={color.colorwayName}
                                                    onChange={(e) => updateColor(idx, 'colorwayName', e.target.value)}
                                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                    list={`colorway-list-${idx}`}
                                                />
                                                <datalist id={`colorway-list-${idx}`}>
                                                    {recipes.map(r => (
                                                        <option key={r.id} value={r.name} />
                                                    ))}
                                                </datalist>
                                            </div>
                                            <input
                                                type="number"
                                                min="1"
                                                placeholder="Qty"
                                                value={color.quantity}
                                                onChange={(e) => updateColor(idx, 'quantity', e.target.value)}
                                                className="w-20 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                            />
                                            {formData.colors.length > 1 && (
                                                <button
                                                    type="button"
                                                    onClick={() => removeColor(idx)}
                                                    className="px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg"
                                                >
                                                    âœ•
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                    <button
                                        type="button"
                                        onClick={addColor}
                                        className="text-purple-600 hover:text-purple-700 text-sm font-medium"
                                    >
                                        + Add Color
                                    </button>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                                    <textarea
                                        value={formData.notes}
                                        onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                                        rows="2"
                                        className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                        placeholder="Any additional notes about this kit..."
                                    />
                                </div>

                                <div className="flex gap-3 pt-4">
                                    <button
                                        type="submit"
                                        className="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors font-medium"
                                    >
                                        {editingId ? 'Update Kit' : 'Save Kit'}
                                    </button>
                                    <button
                                        type="button"
                                        onClick={resetForm}
                                        className="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-300 transition-colors font-medium"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}

                    {/* Kits List */}
                    <div className="grid md:grid-cols-2 gap-6">
                        {kits.map(kit => (
                            <div key={kit.id} className="bg-white rounded-lg card-shadow p-6">
                                <div className="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 className="text-xl font-semibold text-gray-900">{kit.name}</h3>
                                        {kit.description && (
                                            <p className="text-gray-600 text-sm mt-1">{kit.description}</p>
                                        )}
                                    </div>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => editKit(kit)}
                                            className="text-blue-600 hover:bg-blue-50 px-3 py-1 rounded"
                                        >
                                            âœï¸
                                        </button>
                                        <button
                                            onClick={() => deleteKit(kit.id)}
                                            className="text-red-600 hover:bg-red-50 px-3 py-1 rounded"
                                        >
                                            ðŸ—‘ï¸
                                        </button>
                                    </div>
                                </div>

                                <div className="space-y-2">
                                    <h4 className="font-medium text-sm text-gray-700">Colors in Kit:</h4>
                                    <div className="grid grid-cols-2 gap-2">
                                        {kit.colors.map((color, idx) => {
                                            const recipe = recipes.find(r => r.name === color.colorwayName);
                                            return (
                                                <div key={idx} className="flex items-center gap-2 p-2 bg-purple-50 rounded border">
                                                    {recipe && recipe.photo && (
                                                        <img 
                                                            src={recipe.photo} 
                                                            alt={color.colorwayName}
                                                            className="w-12 h-12 object-cover rounded border flex-shrink-0"
                                                        />
                                                    )}
                                                    <div className="flex-1 min-w-0">
                                                        <div className="text-sm font-medium text-gray-900 truncate">
                                                            {color.colorwayName}
                                                        </div>
                                                        {color.quantity > 1 && (
                                                            <div className="text-xs text-gray-600">
                                                                Qty: {color.quantity}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                    
                                    {kit.notes && (
                                        <div className="pt-2 border-t mt-3">
                                            <p className="text-sm text-gray-600"><strong>Notes:</strong> {kit.notes}</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>

                    {kits.length === 0 && !showForm && (
                        <div className="text-center py-12 text-gray-400">
                            <p className="text-xl mb-2">ðŸŽ</p>
                            <p>No kits yet. Create your first kit!</p>
                        </div>
                    )}
                </div>
            );
        }

        // Dye Sessions Component
        function DyeSessions({ dyeSessions, saveDyeSessions, recipes, inventory, settings }) {
            const [showForm, setShowForm] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [expandedSessions, setExpandedSessions] = useState({});
            const [showArchived, setShowArchived] = useState(false);
            const [formData, setFormData] = useState({
                name: '',
                date: new Date().toISOString().split('T')[0],
                pans: [],
                notes: ''
            });
            const [currentPan, setCurrentPan] = useState({
                type: 'pan', // 'pan' or 'gradientTray'
                colorway: '',
                recipeId: '',
                capacity: 300,
                yarns: [{ base: '', hankSize: '', quantity: 1 }],
                // Gradient tray specific
                gradientDye: '',
                gradientYarnBase: '',
                gradientHankSize: ''
            });

            // Calculate oven capacity (pans count as 1, gradient trays count as 2)
            const calculateOvenLoad = (pans) => {
                return pans.reduce((total, pan) => {
                    return total + (pan.type === 'gradientTray' ? 2 : 1);
                }, 0);
            };

            const MAX_OVEN_CAPACITY = 18;

            // Get unique yarn bases and their available hank sizes from inventory
            const yarnBases = inventory
                .filter(item => item.category === 'yarn base')
                .reduce((acc, item) => {
                    if (!acc[item.name]) {
                        acc[item.name] = [];
                    }
                    if (item.hankSize && !acc[item.name].includes(item.hankSize)) {
                        acc[item.name].push(item.hankSize);
                    }
                    return acc;
                }, {});

            const getAvailableHankSizes = (baseName) => {
                return yarnBases[baseName] || [];
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (editingId) {
                    saveDyeSessions(dyeSessions.map(s => s.id === editingId ? { ...formData, id: editingId } : s));
                } else {
                    saveDyeSessions([...dyeSessions, { ...formData, id: Date.now() }]);
                }
                resetForm();
            };

            const resetForm = () => {
                setFormData({
                    name: '',
                    date: new Date().toISOString().split('T')[0],
                    pans: [],
                    notes: ''
                });
                setCurrentPan({
                    type: 'pan',
                    colorway: '',
                    recipeId: '',
                    capacity: 300,
                    yarns: [{ base: '', hankSize: '', quantity: 1 }],
                    gradientDye: '',
                    gradientYarnBase: '',
                    gradientHankSize: ''
                });
                setShowForm(false);
                setEditingId(null);
            };

            const editSession = (session) => {
                setFormData(session);
                setEditingId(session.id);
                setShowForm(true);
            };

            const deleteSession = (id) => {
                if (confirm('Delete this dye session?')) {
                    saveDyeSessions(dyeSessions.filter(s => s.id !== id));
                }
            };

            const addYarnToPan = () => {
                setCurrentPan({
                    ...currentPan,
                    yarns: [...currentPan.yarns, { base: '', hankSize: '', quantity: 1 }]
                });
            };

            const updateYarn = (index, field, value) => {
                const newYarns = [...currentPan.yarns];
                newYarns[index] = { ...newYarns[index], [field]: value };
                setCurrentPan({ ...currentPan, yarns: newYarns });
            };

            const removeYarn = (index) => {
                setCurrentPan({
                    ...currentPan,
                    yarns: currentPan.yarns.filter((_, i) => i !== index)
                });
            };

            const addPanToSession = () => {
                // Validate based on type
                if (currentPan.type === 'pan') {
                    if (!currentPan.colorway) {
                        alert('Please enter a colorway for this pan');
                        return;
                    }
                } else if (currentPan.type === 'gradientTray') {
                    if (!currentPan.gradientDye || !currentPan.gradientYarnBase || !currentPan.gradientHankSize) {
                        alert('Please fill in all gradient tray fields');
                        return;
                    }
                }

                // Check oven capacity
                const currentLoad = calculateOvenLoad(formData.pans);
                const newItemLoad = currentPan.type === 'gradientTray' ? 2 : 1;
                if (currentLoad + newItemLoad > MAX_OVEN_CAPACITY) {
                    alert(`Cannot add this ${currentPan.type === 'gradientTray' ? 'tray' : 'pan'}. Oven capacity exceeded!\n\nCurrent: ${currentLoad}/${MAX_OVEN_CAPACITY}\nAttempting to add: ${newItemLoad}\nMax capacity: ${MAX_OVEN_CAPACITY} pans (or 9 trays)`);
                    return;
                }

                // Check inventory availability
                let inventoryWarnings = [];
                if (currentPan.type === 'gradientTray') {
                    const inventoryItem = inventory.find(
                        item => item.category === 'yarn base' && 
                                item.name === currentPan.gradientYarnBase && 
                                parseFloat(item.hankSize) === parseFloat(currentPan.gradientHankSize)
                    );
                    const available = inventoryItem ? parseFloat(inventoryItem.quantity) : 0;
                    if (available < 10) {
                        inventoryWarnings.push(`${currentPan.gradientYarnBase} (${currentPan.gradientHankSize}g): need 10, have ${available}`);
                    }
                } else {
                    currentPan.yarns.forEach(yarn => {
                        const inventoryItem = inventory.find(
                            item => item.category === 'yarn base' && 
                                    item.name === yarn.base && 
                                    parseFloat(item.hankSize) === parseFloat(yarn.hankSize)
                        );
                        const available = inventoryItem ? parseFloat(inventoryItem.quantity) : 0;
                        const needed = parseInt(yarn.quantity);
                        if (available < needed) {
                            inventoryWarnings.push(`${yarn.base} (${yarn.hankSize}g): need ${needed}, have ${available}`);
                        }
                    });
                }

                if (inventoryWarnings.length > 0) {
                    const proceed = confirm(`âš ï¸ INVENTORY WARNING:\n\n${inventoryWarnings.join('\n')}\n\nDo you want to add this ${currentPan.type === 'gradientTray' ? 'tray' : 'pan'} anyway?`);
                    if (!proceed) return;
                }

                if (currentPan.type === 'pan') {
                    const totalWeight = currentPan.yarns.reduce((sum, y) => {
                        return sum + (parseFloat(y.hankSize) || 0) * (parseInt(y.quantity) || 0);
                    }, 0);
                    
                    const recipe = currentPan.recipeId ? recipes.find(r => r.id === parseInt(currentPan.recipeId)) : null;
                    
                    setFormData({
                        ...formData,
                        pans: [...formData.pans, { 
                            ...currentPan, 
                            id: Date.now(), 
                            totalWeight,
                            recipe: recipe ? {
                                id: recipe.id,
                                name: recipe.name,
                                yarnWeight: recipe.yarnWeight,
                                ingredients: recipe.ingredients,
                                photo: recipe.photo,
                                colorType: recipe.colorType,
                                instructions: recipe.instructions,
                                colorSolutions: recipe.colorSolutions
                            } : null
                        }]
                    });
                } else {
                    // Gradient tray - create 10 colors with specific depths
                    const depths = [0.0625, 0.125, 0.25, 0.5, 0.75, 1, 1.5, 2.0, 2.5, 3.0];
                    setFormData({
                        ...formData,
                        pans: [...formData.pans, {
                            type: 'gradientTray',
                            id: Date.now(),
                            gradientDye: currentPan.gradientDye,
                            gradientYarnBase: currentPan.gradientYarnBase,
                            gradientHankSize: currentPan.gradientHankSize,
                            depths: depths
                        }]
                    });
                }

                // Reset current pan
                setCurrentPan({
                    type: 'pan',
                    colorway: '',
                    recipeId: '',
                    capacity: 300,
                    yarns: [{ base: '', hankSize: '', quantity: 1 }],
                    gradientDye: '',
                    gradientYarnBase: '',
                    gradientHankSize: ''
                });
            };

            const removePan = (panId) => {
                setFormData({
                    ...formData,
                    pans: formData.pans.filter(p => p.id !== panId)
                });
            };

            const getTotalWeight = (yarns) => {
                return yarns.reduce((sum, y) => sum + (parseFloat(y.hankSize) || 0) * (parseInt(y.quantity) || 0), 0);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <div className="flex items-center gap-4">
                            <h2 className="text-2xl font-bold text-gray-900">Dye Sessions Planning</h2>
                            <button
                                onClick={() => setShowArchived(!showArchived)}
                                className={`px-4 py-2 rounded-lg font-medium transition-colors text-sm ${
                                    showArchived 
                                        ? 'bg-gray-600 text-white' 
                                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                }`}
                            >
                                {showArchived ? 'ðŸ“¦ Showing Archived' : 'ðŸ“‹ Show Archived'}
                            </button>
                        </div>
                        <button
                            onClick={() => setShowForm(!showForm)}
                            className="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors font-medium"
                        >
                            {showForm ? 'âœ• Cancel' : '+ Plan Session'}
                        </button>
                    </div>

                    {/* Form */}
                    {showForm && (
                        <div className="bg-white rounded-lg card-shadow p-6">
                            <h3 className="text-xl font-semibold mb-4">{editingId ? 'Edit Session' : 'Plan New Dye Session'}</h3>
                            <form onSubmit={handleSubmit} className="space-y-6">
                                <div className="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Session Name *</label>
                                        <input
                                            type="text"
                                            required
                                            value={formData.name}
                                            onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                            placeholder="e.g., Weekend Batch #1"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Planned Date *</label>
                                        <input
                                            type="date"
                                            required
                                            value={formData.date}
                                            onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                        />
                                    </div>
                                </div>

                                {/* Current Pan/Tray Builder */}
                                <div className="border-2 border-purple-200 rounded-lg p-4 bg-purple-50">
                                    <div className="flex justify-between items-center mb-3">
                                        <h4 className="font-semibold text-gray-900">Add to Session</h4>
                                        <div className="text-sm text-gray-600">
                                            Oven: {calculateOvenLoad(formData.pans)}/18 pans (or {Math.floor(calculateOvenLoad(formData.pans)/2)}/9 trays)
                                        </div>
                                    </div>
                                    
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Type *</label>
                                        <select
                                            value={currentPan.type}
                                            onChange={(e) => setCurrentPan({ 
                                                type: e.target.value,
                                                colorway: '',
                                                recipeId: '',
                                                capacity: 300,
                                                yarns: [{ base: '', hankSize: '', quantity: 1 }],
                                                gradientDye: '',
                                                gradientYarnBase: '',
                                                gradientHankSize: ''
                                            })}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 bg-white"
                                        >
                                            <option value="pan">Pan (1 space)</option>
                                            <option value="gradientTray">10-Color Gradient Tray (2 spaces)</option>
                                        </select>
                                    </div>

                                    {/* Pan Form */}
                                    {currentPan.type === 'pan' && (
                                        <>
                                            <div className="grid md:grid-cols-2 gap-4 mb-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Colorway *</label>
                                                    <input
                                                        type="text"
                                                        value={currentPan.colorway}
                                                        onChange={(e) => setCurrentPan({ ...currentPan, colorway: e.target.value })}
                                                        className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 bg-white"
                                                        placeholder="e.g., Cranberry Spice"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Recipe (Optional)</label>
                                                    <select
                                                        value={currentPan.recipeId}
                                                        onChange={(e) => {
                                                            const recipe = recipes.find(r => r.id === parseInt(e.target.value));
                                                            setCurrentPan({ 
                                                                ...currentPan, 
                                                                recipeId: e.target.value,
                                                                colorway: recipe ? recipe.name : currentPan.colorway
                                                            });
                                                        }}
                                                        className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 bg-white"
                                                    >
                                                        <option value="">Select recipe...</option>
                                                        {recipes.map(r => (
                                                            <option key={r.id} value={r.id}>{r.name}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <div className="mb-4">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Pan Capacity (g)</label>
                                                <input
                                                    type="number"
                                                    value={currentPan.capacity}
                                                    onChange={(e) => setCurrentPan({ ...currentPan, capacity: e.target.value })}
                                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 bg-white"
                                                />
                                            </div>

                                            <div className="mb-3">
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Yarns in Pan</label>
                                                {currentPan.yarns.map((yarn, idx) => (
                                                    <div key={idx} className="flex gap-2 mb-2">
                                                        <select
                                                            value={yarn.base || ''}
                                                            onChange={(e) => {
                                                                const baseName = e.target.value;
                                                                const newYarns = [...currentPan.yarns];
                                                                
                                                                // Auto-populate first available hank size
                                                                let hankSize = '';
                                                                if (baseName) {
                                                                    const sizes = getAvailableHankSizes(baseName);
                                                                    if (sizes.length > 0) {
                                                                        hankSize = sizes[0];
                                                                    }
                                                                }
                                                                
                                                                newYarns[idx] = { ...newYarns[idx], base: baseName, hankSize: hankSize };
                                                                setCurrentPan({ ...currentPan, yarns: newYarns });
                                                            }}
                                                            className="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 bg-white"
                                                        >
                                                            <option value="">Select yarn base...</option>
                                                            {Object.keys(yarnBases).map(baseName => (
                                                                <option key={baseName} value={baseName}>{baseName}</option>
                                                            ))}
                                                        </select>
                                                        <select
                                                            value={yarn.hankSize || ''}
                                                            onChange={(e) => updateYarn(idx, 'hankSize', e.target.value)}
                                                            className="w-32 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 bg-white"
                                                            disabled={!yarn.base}
                                                        >
                                                            <option value="">Size (g)</option>
                                                            {yarn.base && getAvailableHankSizes(yarn.base).map(size => (
                                                                <option key={size} value={size}>{size}g</option>
                                                            ))}
                                                        </select>
                                                        <input
                                                            type="number"
                                                            placeholder="Qty"
                                                            value={yarn.quantity || ''}
                                                            onChange={(e) => updateYarn(idx, 'quantity', e.target.value)}
                                                            className="w-20 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 bg-white"
                                                        />
                                                        {currentPan.yarns.length > 1 && (
                                                            <button
                                                                type="button"
                                                                onClick={() => removeYarn(idx)}
                                                                className="px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg"
                                                            >
                                                                âœ•
                                                            </button>
                                                        )}
                                                    </div>
                                                ))}
                                                <button
                                                    type="button"
                                                    onClick={addYarnToPan}
                                                    className="text-purple-600 hover:text-purple-700 text-sm font-medium"
                                                >
                                                    + Add Yarn
                                                </button>
                                            </div>

                                            <div className="flex justify-between items-center pt-2 border-t">
                                                <div className="text-sm">
                                                    <span className="text-gray-600">Total weight: </span>
                                                    <span className="font-semibold">{getTotalWeight(currentPan.yarns)}g</span>
                                                    <span className="text-gray-600"> / {currentPan.capacity}g capacity</span>
                                                </div>
                                                <button
                                                    type="button"
                                                    onClick={addPanToSession}
                                                    className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm font-medium"
                                                >
                                                    Add Pan
                                                </button>
                                            </div>
                                        </>
                                    )}

                                    {/* Gradient Tray Form */}
                                    {currentPan.type === 'gradientTray' && (
                                        <>
                                            <div className="space-y-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Dye Color *</label>
                                                    <select
                                                        value={currentPan.gradientDye}
                                                        onChange={(e) => setCurrentPan({ ...currentPan, gradientDye: e.target.value })}
                                                        className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 bg-white"
                                                    >
                                                        <option value="">Select dye...</option>
                                                        {inventory.filter(item => item.category === 'dye').map(dye => (
                                                            <option key={dye.id} value={dye.name}>{dye.name}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Yarn Base *</label>
                                                    <select
                                                        value={currentPan.gradientYarnBase}
                                                        onChange={(e) => {
                                                            const baseName = e.target.value;
                                                            const sizes = baseName ? getAvailableHankSizes(baseName) : [];
                                                            setCurrentPan({ 
                                                                ...currentPan, 
                                                                gradientYarnBase: baseName, 
                                                                gradientHankSize: sizes.length > 0 ? sizes[0] : ''
                                                            });
                                                        }}
                                                        className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 bg-white"
                                                    >
                                                        <option value="">Select yarn base...</option>
                                                        {Object.keys(yarnBases).map(baseName => (
                                                            <option key={baseName} value={baseName}>{baseName}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Hank Size *</label>
                                                    <select
                                                        value={currentPan.gradientHankSize}
                                                        onChange={(e) => setCurrentPan({ ...currentPan, gradientHankSize: e.target.value })}
                                                        className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 bg-white"
                                                        disabled={!currentPan.gradientYarnBase}
                                                    >
                                                        <option value="">Select size...</option>
                                                        {currentPan.gradientYarnBase && getAvailableHankSizes(currentPan.gradientYarnBase).map(size => (
                                                            <option key={size} value={size}>{size}g</option>
                                                        ))}
                                                    </select>
                                                </div>
                                                <div className="bg-blue-50 p-3 rounded text-sm text-gray-700">
                                                    <p className="font-medium mb-1">10-Color Gradient</p>
                                                    <p className="text-xs">Depths: 0.0625%, 0.125%, 0.25%, 0.5%, 0.75%, 1%, 1.5%, 2%, 2.5%, 3%</p>
                                                    <p className="text-xs text-gray-600 mt-1">Automatically creates 10 colors from lightest to darkest</p>
                                                </div>
                                            </div>

                                            <div className="flex justify-end pt-4 border-t mt-4">
                                                <button
                                                    type="button"
                                                    onClick={addPanToSession}
                                                    className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm font-medium"
                                                >
                                                    Add Gradient Tray
                                                </button>
                                            </div>
                                        </>
                                    )}
                                </div>

                                {/* Pans in Session */}
                                {formData.pans.length > 0 && (
                                    <div>
                                        <h4 className="font-semibold text-gray-900 mb-3">
                                            Pans/Trays in This Session ({formData.pans.length} items, {calculateOvenLoad(formData.pans)}/18 spaces)
                                        </h4>
                                        <div className="space-y-2">
                                            {formData.pans.map((pan, idx) => (
                                                <div key={pan.id} className="bg-gray-50 rounded-lg p-4 border flex gap-3">
                                                    {/* Reorder buttons */}
                                                    <div className="flex flex-col gap-1">
                                                        <button
                                                            type="button"
                                                            onClick={() => {
                                                                if (idx > 0) {
                                                                    const newPans = [...formData.pans];
                                                                    [newPans[idx - 1], newPans[idx]] = [newPans[idx], newPans[idx - 1]];
                                                                    setFormData({ ...formData, pans: newPans });
                                                                }
                                                            }}
                                                            disabled={idx === 0}
                                                            className={`px-2 py-1 text-sm ${idx === 0 ? 'text-gray-300' : 'text-gray-600 hover:bg-gray-200'} rounded`}
                                                        >
                                                            â–²
                                                        </button>
                                                        <button
                                                            type="button"
                                                            onClick={() => {
                                                                if (idx < formData.pans.length - 1) {
                                                                    const newPans = [...formData.pans];
                                                                    [newPans[idx], newPans[idx + 1]] = [newPans[idx + 1], newPans[idx]];
                                                                    setFormData({ ...formData, pans: newPans });
                                                                }
                                                            }}
                                                            disabled={idx === formData.pans.length - 1}
                                                            className={`px-2 py-1 text-sm ${idx === formData.pans.length - 1 ? 'text-gray-300' : 'text-gray-600 hover:bg-gray-200'} rounded`}
                                                        >
                                                            â–¼
                                                        </button>
                                                    </div>

                                                    {/* Recipe image or gradient icon */}
                                                    {pan.type === 'gradientTray' ? (
                                                        (() => {
                                                            const dye = inventory.find(i => i.name === pan.gradientDye);
                                                            const baseColor = dye?.color || '#9333ea';
                                                            return (
                                                                <div 
                                                                    className="w-20 h-20 rounded border flex-shrink-0 flex items-center justify-center"
                                                                    style={{
                                                                        background: `linear-gradient(to right, ${baseColor}15, ${baseColor}60, ${baseColor})`
                                                                    }}
                                                                >
                                                                    <span className="text-3xl">ðŸŽ¨</span>
                                                                </div>
                                                            );
                                                        })()
                                                    ) : pan.recipe && pan.recipe.photo ? (
                                                        <img 
                                                            src={pan.recipe.photo} 
                                                            alt={pan.colorway}
                                                            className="w-20 h-20 object-cover rounded border"
                                                        />
                                                    ) : (
                                                        <div className="w-20 h-20 rounded border flex-shrink-0 bg-gray-200 flex items-center justify-center">
                                                            <span className="text-3xl">ðŸ“</span>
                                                        </div>
                                                    )}

                                                    {/* Content */}
                                                    <div className="flex-1">
                                                        {pan.type === 'gradientTray' ? (
                                                            <>
                                                                <div className="font-medium text-gray-900">
                                                                    #{idx + 1}: ðŸŽ¨ Gradient Tray - {pan.gradientDye} (2 spaces)
                                                                </div>
                                                                <div className="text-sm text-gray-600">
                                                                    {pan.gradientYarnBase} ({pan.gradientHankSize}g) - 10 colors
                                                                </div>
                                                                <div className="flex gap-1 mt-2">
                                                                    {pan.depths.map((depth, i) => (
                                                                        <div key={i} className="text-xs bg-white px-2 py-1 rounded border">
                                                                            {depth}%
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </>
                                                        ) : (
                                                            <>
                                                                <div className="flex justify-between items-start">
                                                                    <div>
                                                                        <div className="font-medium text-gray-900">Pan #{idx + 1}: {pan.colorway}</div>
                                                                        <div className="text-sm text-gray-600">{pan.totalWeight}g / {pan.capacity}g capacity</div>
                                                                    </div>
                                                                </div>
                                                                <div className="text-sm text-gray-600 mt-1">
                                                                    {pan.yarns.map((y, i) => (
                                                                        <div key={i}>â€¢ {y.quantity}x {y.base} ({y.hankSize}g)</div>
                                                                    ))}
                                                                </div>
                                                            </>
                                                        )}
                                                    </div>

                                                    {/* Edit and Remove buttons */}
                                                    <div className="flex gap-2">
                                                        <button
                                                            type="button"
                                                            onClick={() => {
                                                                // Remove from the list first
                                                                const updatedPans = formData.pans.filter(p => p.id !== pan.id);
                                                                setFormData({ ...formData, pans: updatedPans });
                                                                
                                                                // Load pan into currentPan for editing based on type
                                                                if (pan.type === 'gradientTray') {
                                                                    setCurrentPan({
                                                                        type: 'gradientTray',
                                                                        colorway: '',
                                                                        recipeId: '',
                                                                        capacity: 300,
                                                                        yarns: [{ base: '', hankSize: '', quantity: 1 }],
                                                                        gradientDye: pan.gradientDye,
                                                                        gradientYarnBase: pan.gradientYarnBase,
                                                                        gradientHankSize: pan.gradientHankSize
                                                                    });
                                                                } else {
                                                                    setCurrentPan({
                                                                        type: 'pan',
                                                                        colorway: pan.colorway,
                                                                        recipeId: pan.recipeId || '',
                                                                        capacity: pan.capacity,
                                                                        yarns: pan.yarns,
                                                                        gradientDye: '',
                                                                        gradientYarnBase: '',
                                                                        gradientHankSize: ''
                                                                    });
                                                                }
                                                            }}
                                                            className="text-blue-600 hover:text-blue-800"
                                                        >
                                                            âœï¸
                                                        </button>
                                                        <button
                                                            type="button"
                                                            onClick={() => {
                                                                const newPan = {
                                                                    ...pan,
                                                                    id: Date.now() + Math.random()
                                                                };
                                                                setFormData({
                                                                    ...formData,
                                                                    pans: [...formData.pans, newPan]
                                                                });
                                                            }}
                                                            className="text-blue-600 hover:text-blue-800"
                                                            title="Copy pan"
                                                        >
                                                            ðŸ“‹
                                                        </button>
                                                        <button
                                                            type="button"
                                                            onClick={() => removePan(pan.id)}
                                                            className="text-red-600 hover:text-red-800"
                                                        >
                                                            âœ•
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Session Notes</label>
                                    <textarea
                                        value={formData.notes}
                                        onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                                        rows="3"
                                        className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                        placeholder="Any notes about this dye session..."
                                    />
                                </div>

                                <div className="flex gap-3 pt-4">
                                    <button
                                        type="submit"
                                        className="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors font-medium"
                                    >
                                        {editingId ? 'Update Session' : 'Save Session'}
                                    </button>
                                    <button
                                        type="button"
                                        onClick={resetForm}
                                        className="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-300 transition-colors font-medium"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}

                    {/* Sessions List */}
                    <div className="space-y-4">
                        {dyeSessions
                            .filter(session => showArchived ? session.archived : !session.archived) // Filter by archive status
                            .sort((a, b) => new Date(a.date) - new Date(b.date)) // Sort by date, earliest first
                            .map(session => (
                            <div key={session.id} className={`bg-white rounded-lg card-shadow p-6 ${session.archived ? 'opacity-75 border-2 border-gray-300' : ''}`}>
                                <div className="flex justify-between items-start mb-4">
                                    <div className="flex-1">
                                        <div className="flex items-center gap-2">
                                            <button
                                                onClick={() => setExpandedSessions({
                                                    ...expandedSessions,
                                                    [session.id]: !expandedSessions[session.id]
                                                })}
                                                className="text-gray-600 hover:text-gray-900"
                                            >
                                                {expandedSessions[session.id] ? 'â–¼' : 'â–¶'}
                                            </button>
                                            <h3 className="text-xl font-semibold text-gray-900">
                                                {session.name}
                                                {session.archived && <span className="ml-2 text-sm text-gray-500">(Archived)</span>}
                                            </h3>
                                        </div>
                                        <p className="text-sm text-gray-500 ml-8">
                                            {session.date} â€¢ {session.pans.filter(p => p.type !== 'gradientTray').length} pan(s) â€¢ {session.pans.filter(p => p.type === 'gradientTray').length} tray(s)
                                        </p>
                                        <p className="text-xs text-purple-600 mt-1 ml-8">
                                            Yarn bases needed: {(() => {
                                                const bases = {};
                                                session.pans.forEach(pan => {
                                                    if (pan.type === 'gradientTray') {
                                                        const key = `${pan.gradientYarnBase} (${pan.gradientHankSize}g)`;
                                                        bases[key] = (bases[key] || 0) + 10;
                                                    } else {
                                                        pan.yarns.forEach(y => {
                                                            const key = `${y.base} (${y.hankSize}g)`;
                                                            bases[key] = (bases[key] || 0) + parseInt(y.quantity);
                                                        });
                                                    }
                                                });
                                                return Object.entries(bases).map(([base, qty]) => `${qty}x ${base}`).join(', ');
                                            })()}
                                        </p>
                                        <p className="text-xs text-blue-600 mt-1 ml-8">
                                            Dye colors needed: {(() => {
                                                const dyes = new Set();
                                                session.pans.forEach(pan => {
                                                    if (pan.type === 'gradientTray') {
                                                        if (pan.gradientDye) dyes.add(pan.gradientDye);
                                                    } else if (pan.recipeId) {
                                                        const recipe = recipes.find(r => r.id === parseInt(pan.recipeId));
                                                        if (recipe) {
                                                            if (recipe.colorType === 'variegated' && recipe.colorSolutions) {
                                                                recipe.colorSolutions.forEach(sol => {
                                                                    sol.dyes.forEach(d => dyes.add(d.name));
                                                                });
                                                            } else if (recipe.ingredients) {
                                                                recipe.ingredients.forEach(ing => {
                                                                    const item = inventory.find(i => i.name === ing.name);
                                                                    if (item?.category === 'dye') dyes.add(ing.name);
                                                                });
                                                            }
                                                        }
                                                    }
                                                });
                                                return Array.from(dyes).sort().join(', ') || 'None';
                                            })()}
                                        </p>
                                        {/* Inventory shortage warning */}
                                        {(() => {
                                            const shortages = [];
                                            session.pans.forEach(pan => {
                                                if (pan.type === 'gradientTray') {
                                                    const inventoryItem = inventory.find(
                                                        item => item.category === 'yarn base' && 
                                                                item.name === pan.gradientYarnBase && 
                                                                parseFloat(item.hankSize) === parseFloat(pan.gradientHankSize)
                                                    );
                                                    const available = inventoryItem ? parseFloat(inventoryItem.quantity) : 0;
                                                    if (available < 10) {
                                                        shortages.push(`${pan.gradientYarnBase} (${pan.gradientHankSize}g): need 10, have ${available}`);
                                                    }
                                                } else {
                                                    pan.yarns.forEach(yarn => {
                                                        const inventoryItem = inventory.find(
                                                            item => item.category === 'yarn base' && 
                                                                    item.name === yarn.base && 
                                                                    parseFloat(item.hankSize) === parseFloat(yarn.hankSize)
                                                        );
                                                        const available = inventoryItem ? parseFloat(inventoryItem.quantity) : 0;
                                                        const needed = parseInt(yarn.quantity);
                                                        if (available < needed) {
                                                            const existingShortage = shortages.find(s => s.startsWith(`${yarn.base} (${yarn.hankSize}g):`));
                                                            if (!existingShortage) {
                                                                shortages.push(`${yarn.base} (${yarn.hankSize}g): need ${needed}, have ${available}`);
                                                            }
                                                        }
                                                    });
                                                }
                                            });
                                            
                                            if (shortages.length > 0) {
                                                return (
                                                    <div className="mt-2 bg-red-50 border border-red-300 rounded p-2">
                                                        <p className="text-xs font-semibold text-red-800">âš ï¸ Insufficient inventory:</p>
                                                        <ul className="text-xs text-red-700 mt-1 space-y-0.5">
                                                            {shortages.map((shortage, idx) => (
                                                                <li key={idx}>â€¢ {shortage}</li>
                                                            ))}
                                                        </ul>
                                                    </div>
                                                );
                                            }
                                            return null;
                                        })()}
                                        
                                        {/* Session Cost Summary */}
                                        {settings && (() => {
                                            let totalCost = 0;
                                            let totalSkeins = 0;
                                            
                                            session.pans.forEach(pan => {
                                                if (pan.type === 'gradientTray') {
                                                    totalSkeins += 10;
                                                    // Simplified gradient cost calculation
                                                    const yarnItem = inventory.find(i => 
                                                        i.category === 'yarn base' && 
                                                        i.name === pan.gradientYarnBase && 
                                                        parseFloat(i.hankSize) === parseFloat(pan.gradientHankSize)
                                                    );
                                                    if (yarnItem?.cost) {
                                                        totalCost += parseFloat(yarnItem.cost) * 10;
                                                    }
                                                } else {
                                                    const skeins = pan.yarns.reduce((sum, y) => sum + parseInt(y.quantity || 0), 0);
                                                    totalSkeins += skeins;
                                                    pan.yarns.forEach(yarn => {
                                                        const yarnItem = inventory.find(i => 
                                                            i.category === 'yarn base' && 
                                                            i.name === yarn.base && 
                                                            parseFloat(i.hankSize) === parseFloat(yarn.hankSize)
                                                        );
                                                        if (yarnItem?.cost) {
                                                            totalCost += parseFloat(yarnItem.cost) * parseInt(yarn.quantity);
                                                        }
                                                    });
                                                }
                                            });
                                            
                                            const costPerSkein = totalSkeins > 0 ? totalCost / totalSkeins : 0;
                                            
                                            return (
                                                <div className="mt-2 bg-blue-50 border border-blue-300 rounded p-2">
                                                    <p className="text-xs font-semibold text-blue-900">ðŸ’° Estimated Cost</p>
                                                    <div className="text-xs text-blue-800 mt-1">
                                                        <span>Total: ${totalCost.toFixed(2)}</span>
                                                        <span className="mx-2">â€¢</span>
                                                        <span>${costPerSkein.toFixed(2)}/skein</span>
                                                        <span className="mx-2">â€¢</span>
                                                        <span>{totalSkeins} skeins</span>
                                                    </div>
                                                </div>
                                            );
                                        })()}
                                    </div>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => {
                                                const updatedSessions = dyeSessions.map(s => 
                                                    s.id === session.id ? { ...s, archived: !s.archived } : s
                                                );
                                                saveDyeSessions(updatedSessions);
                                            }}
                                            className={`${session.archived ? 'text-green-600 hover:bg-green-50' : 'text-orange-600 hover:bg-orange-50'} px-3 py-1 rounded`}
                                            title={session.archived ? 'Unarchive session' : 'Archive session'}
                                        >
                                            {session.archived ? 'ðŸ“‚' : 'ðŸ“¦'}
                                        </button>
                                        <button
                                            onClick={() => editSession(session)}
                                            className="text-blue-600 hover:bg-blue-50 px-3 py-1 rounded"
                                        >
                                            âœï¸
                                        </button>
                                        <button
                                            onClick={() => deleteSession(session.id)}
                                            className="text-red-600 hover:bg-red-50 px-3 py-1 rounded"
                                        >
                                            ðŸ—‘ï¸
                                        </button>
                                    </div>
                                </div>

{expandedSessions[session.id] && (
  <div className="space-y-3">
    {session.pans.map((pan, idx) => (
      <div
        key={pan.id}
        className="border-l-4 border-purple-500 bg-purple-50 rounded p-3 flex gap-3"
      >
        {/* Recipe image or gradient icon */}
        {pan.type === "gradientTray" ? (
          (() => {
            const dye = inventory.find(i => i.name === pan.gradientDye);
            const baseColor = dye?.color || "#9333ea";
            return (
              <div
                className="w-12 h-12 rounded border flex-shrink-0 flex items-center justify-center"
                style={{
                  background: `linear-gradient(to right, ${baseColor}15, ${baseColor}60, ${baseColor})`,
                }}
              >
                <span className="text-xl">ðŸŽ¨</span>
              </div>
            );
          })()
        ) : pan.recipe && pan.recipe.photo ? (
          <img
            src={pan.recipe.photo}
            alt={pan.colorway}
            className="w-12 h-12 object-cover rounded border flex-shrink-0"
          />
        ) : (
          <div className="w-12 h-12 rounded border flex-shrink-0 bg-gray-200 flex items-center justify-center">
            <span className="text-xl">ðŸ“</span>
          </div>
        )}

        <div className="flex-1">
          {pan.type === "gradientTray" ? (
            <>
              <div className="font-medium text-gray-900 mb-1">
                ðŸŽ¨ Gradient Tray #{idx + 1}: {pan.gradientDye}
              </div>
              <div className="text-sm text-gray-600 mb-2">
                {pan.gradientYarnBase} ({pan.gradientHankSize}g) - 10 colors
              </div>
              <div className="flex gap-1 flex-wrap">
                {pan.depths.map((depth, i) => (
                  <span key={i} className="text-xs bg-white px-2 py-1 rounded border">
                    {depth}%
                  </span>
                ))}
              </div>
            </>
          ) : (
            <>
              <div className="font-medium text-gray-900 mb-1">
                Pan #{idx + 1}: {pan.colorway}
              </div>
              <div className="text-sm text-gray-600 mb-2">
                Total: {pan.totalWeight}g / {pan.capacity}g capacity
              </div>
              <div className="text-sm text-gray-700">
                {pan.yarns.map((y, i) => (
                  <div key={i}>
                    â€¢ {y.quantity}x {y.base} ({y.hankSize}g each)
                  </div>
                ))}
              </div>
            </>
          )}
        </div>
      </div>
    ))}
  </div>
)}

                                
                                {session.notes && (
                                    <div className="pt-2 border-t mt-2">
                                        <p className="text-sm text-gray-600"><strong>Notes:</strong> {session.notes}</p>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>

                    {dyeSessions.length === 0 && !showForm && (
                        <div className="text-center py-12 text-gray-400">
                            <p className="text-xl mb-2">ðŸŽ¨</p>
                            <p>No dye sessions planned yet. Plan your first session!</p>
                        </div>
                    )}
                </div>
            );
        }

        // Up Next Component
        function UpNext({ dyeSessions, saveDyeSessions, batches, saveBatches, inventory, saveInventory, recipes, settings }) {
            const [selectedSessionId, setSelectedSessionId] = useState('');
            const [currentPanIndex, setCurrentPanIndex] = useState(0);

            // Get upcoming sessions (today or future)
            const today = new Date().toISOString().split('T')[0];
            const upcomingSessions = dyeSessions
                .filter(s => s.date >= today && s.pans.length > 0)
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            // Auto-select first session if none selected
            React.useEffect(() => {
                if (!selectedSessionId && upcomingSessions.length > 0) {
                    setSelectedSessionId(upcomingSessions[0].id.toString());
                    setCurrentPanIndex(0);
                }
            }, [upcomingSessions.length]);

            const selectedSession = dyeSessions.find(s => s.id === parseInt(selectedSessionId));
            const currentPan = selectedSession?.pans[currentPanIndex];
            
            // Get fresh recipe data if pan has a recipe
            const currentRecipe = currentPan?.recipeId 
                ? recipes.find(r => r.id === parseInt(currentPan.recipeId))
                : (currentPan?.recipe || null);

            const scaleIngredients = (recipe, targetWeight) => {
                if (!recipe) return [];
                const scaleFactor = targetWeight / parseFloat(recipe.yarnWeight || 100);
                
                if (recipe.colorType === 'variegated' && recipe.colorSolutions) {
                    // Scale color solutions
                    return recipe.colorSolutions.map(solution => ({
                        ...solution,
                        scaledTargetMl: solution.targetMl ? (parseFloat(solution.targetMl) * scaleFactor).toFixed(1) : '',
                        dyes: solution.dyes.map(dye => ({
                            ...dye,
                            scaledAmount: (parseFloat(dye.amount || 0) * scaleFactor).toFixed(2)
                        }))
                    }));
                } else if (recipe.ingredients) {
                    // Scale regular ingredients
                    return recipe.ingredients.map(ing => ({
                        ...ing,
                        scaledAmount: (parseFloat(ing.amount) * scaleFactor).toFixed(2)
                    }));
                }
                return [];
            };

            // Helper: Convert any cost to cost per gram
            const getCostPerGram = (item) => {
                if (!item || !item.cost) return 0;
                const cost = parseFloat(item.cost);
                const unit = item.unit || 'g';
                
                // Conversion factors to grams
                const conversions = {
                    'g': 1,
                    'oz': 28.3495,
                    'lb': 453.592,
                    'kg': 1000,
                    'ml': 1,  // Assume 1ml = 1g for liquids
                    'L': 1000,
                    'tsp': 5,  // Approximate
                    'tbsp': 15  // Approximate
                };
                
                const factor = conversions[unit] || 1;
                return cost / factor;
            };

            // Calculate costs for a pan - returns both total and per-skein breakdown
            const calculatePanCosts = (pan, recipe) => {
                // Safety check
                if (!settings) {
                    return {
                        yarn: 0, dye: 0, chemicals: 0, ballBands: 0, labels: 0,
                        total: 0, perSkein: 0, skeins: 0, skeinDetails: []
                    };
                }
                
                let costs = {
                    yarn: 0,
                    dye: 0,
                    chemicals: 0,
                    ballBands: 0,
                    labels: 0,
                    total: 0,
                    perSkein: 0,
                    skeins: 0,
                    skeinDetails: [] // Array of { base, hankSize, cost } for each individual skein
                };

                // Citric acid cost - ~20g per pan
                const citricAcid = inventory.find(i => 
                    i.category === 'chemical' && 
                    i.name.toLowerCase().includes('citric')
                );
                if (citricAcid) {
                    const costPerGram = getCostPerGram(citricAcid);
                    costs.chemicals = costPerGram * 20; // 20g per pan
                }

                if (pan.type === 'gradientTray') {
                    // Gradient tray costs - all skeins are identical
                    costs.skeins = 10;
                    
                    const yarnItem = inventory.find(i => 
                        i.category === 'yarn base' && 
                        i.name === pan.gradientYarnBase && 
                        parseFloat(i.hankSize) === parseFloat(pan.gradientHankSize)
                    );
                    
                    const totalGramsYarn = parseFloat(pan.gradientHankSize) * 10;
                    
                    // Dye cost
                    const dye = inventory.find(i => i.category === 'dye' && i.name === pan.gradientDye);
                    if (dye) {
                        const totalDepth = pan.depths.reduce((sum, d) => sum + d, 0);
                        const dyeNeeded = (totalGramsYarn * totalDepth) / 100;
                        const costPerGram = getCostPerGram(dye);
                        costs.dye = dyeNeeded * costPerGram;
                    }

                    // Ball band - match both yarn base AND hank size
                    const ballBand = inventory.find(i => 
                        i.category === 'ball band' && 
                        i.forYarnBase === pan.gradientYarnBase &&
                        parseFloat(i.hankSize) === parseFloat(pan.gradientHankSize)
                    );
                    
                    // Label
                    const labelItem = inventory.find(i => i.category === 'other' && i.name.toLowerCase().includes('label'));
                    
                    // Calculate per-skein cost (all skeins identical)
                    const yarnCost = yarnItem?.cost ? parseFloat(yarnItem.cost) : 0;
                    const dyeCostPerSkein = costs.dye / 10;
                    const chemicalCostPerSkein = costs.chemicals / 10;
                    const ballBandCost = ballBand?.cost ? parseFloat(ballBand.cost) : 0;
                    const labelCost = labelItem?.cost ? parseFloat(labelItem.cost) : 0;
                    
                    const costPerSkein = yarnCost + dyeCostPerSkein + chemicalCostPerSkein + ballBandCost + labelCost;
                    
                    // All 10 skeins have same cost
                    for (let i = 0; i < 10; i++) {
                        costs.skeinDetails.push({
                            base: pan.gradientYarnBase,
                            hankSize: pan.gradientHankSize,
                            cost: costPerSkein
                        });
                    }
                    
                    costs.yarn = yarnCost * 10;
                    costs.ballBands = ballBandCost * 10;
                    costs.labels = labelCost * 10;

                } else {
                    // Regular pan - calculate based on weight ratios
                    const totalWeight = pan.totalWeight || pan.yarns.reduce((sum, y) => 
                        sum + (parseFloat(y.hankSize) || 0) * (parseInt(y.quantity) || 0), 0
                    );
                    
                    costs.skeins = pan.yarns.reduce((sum, y) => sum + parseInt(y.quantity || 0), 0);
                    
                    // Dye and additional chemical costs from recipe
                    if (recipe) {
                        const scaledIngredients = scaleIngredients(recipe, totalWeight);
                        console.log('ðŸŽ¨ DYE COST DEBUG:', { 
                            recipeName: recipe.name,
                            colorType: recipe.colorType,
                            totalWeight,
                            scaledIngredients 
                        });
                        
                        if (recipe.colorType === 'variegated') {
                            // For variegated: each solution contains dyes
                            // When you use the solution, you use ALL the dyes that went into making it
                            scaledIngredients.forEach(solution => {
                                console.log('  Solution:', solution.scaledTargetMl + 'ml');
                                solution.dyes.forEach(dye => {
                                    const amount = parseFloat(dye.scaledAmount || 0);
                                    const unit = dye.unit || 'g';
                                    
                                    // Convert to grams
                                    let gramsOfDye = amount;
                                    if (unit === 'ml') {
                                        // For stock solutions: ml of stock / 100 = grams of dye powder
                                        gramsOfDye = amount / 100;
                                    }
                                    // else already in grams
                                    
                                    const dyeItem = inventory.find(i => i.category === 'dye' && i.name === dye.name);
                                    if (dyeItem) {
                                        const costPerGram = getCostPerGram(dyeItem);
                                        const dyeCost = gramsOfDye * costPerGram;
                                        console.log('    -', dye.name, ':', gramsOfDye + 'g', '(from ' + amount + unit + ') Ã—', '$' + costPerGram.toFixed(4) + '/g', '=', '$' + dyeCost.toFixed(4));
                                        costs.dye += dyeCost;
                                    } else {
                                        console.log('    -', dye.name, ': NOT FOUND IN INVENTORY');
                                    }
                                });
                            });
                        } else {
                            // Tonal/Speckled: ingredients have units (ml, g, tsp, tbsp)
                            scaledIngredients.forEach(ing => {
                                const item = inventory.find(i => i.name === ing.name);
                                if (item && item.category === 'dye') {
                                    const amount = parseFloat(ing.scaledAmount || 0);
                                    const unit = ing.unit || 'g';
                                    
                                    // Convert amount to grams based on unit
                                    let gramsOfDye = amount;
                                    if (unit === 'ml') {
                                        // For stock solutions: 1% = 1g dye per 100ml
                                        // So 450ml of stock solution = 450/100 = 4.5g of dye powder
                                        gramsOfDye = amount / 100;
                                    } else if (unit === 'tsp') {
                                        gramsOfDye = amount * 5; // 1 tsp â‰ˆ 5g
                                    } else if (unit === 'tbsp') {
                                        gramsOfDye = amount * 15; // 1 tbsp â‰ˆ 15g
                                    }
                                    // else unit is already 'g'
                                    
                                    const costPerGram = getCostPerGram(item);
                                    const dyeCost = gramsOfDye * costPerGram;
                                    console.log('  -', ing.name, ':', gramsOfDye + 'g', '(from ' + amount + unit + ') Ã—', '$' + costPerGram.toFixed(4) + '/g', '=', '$' + dyeCost.toFixed(4));
                                    costs.dye += dyeCost;
                                } else if (item) {
                                    console.log('  -', ing.name, ': not a dye (category:', item.category + ')');
                                }
                            });
                        }
                    }
                    
                    // Calculate cost for each individual skein based on weight ratio
                    pan.yarns.forEach(yarnGroup => {
                        const yarnItem = inventory.find(i => 
                            i.category === 'yarn base' && 
                            i.name === yarnGroup.base && 
                            parseFloat(i.hankSize) === parseFloat(yarnGroup.hankSize)
                        );
                        
                        // Ball band - match both yarn base AND hank size
                        const ballBand = inventory.find(i => 
                            i.category === 'ball band' && 
                            i.forYarnBase === yarnGroup.base &&
                            parseFloat(i.hankSize) === parseFloat(yarnGroup.hankSize)
                        );
                        
                        const labelItem = inventory.find(i => i.category === 'other' && i.name.toLowerCase().includes('label'));
                        
                        const hankSize = parseFloat(yarnGroup.hankSize);
                        const quantity = parseInt(yarnGroup.quantity);
                        const weightRatio = hankSize / totalWeight; // This skein's proportion of total dye/chemicals
                        
                        const yarnCost = yarnItem?.cost ? parseFloat(yarnItem.cost) : 0;
                        const dyeCostPerSkein = costs.dye * weightRatio;
                        const chemicalCostPerSkein = costs.chemicals * weightRatio;
                        const ballBandCost = ballBand?.cost ? parseFloat(ballBand.cost) : 0;
                        const labelCost = labelItem?.cost ? parseFloat(labelItem.cost) : 0;
                        
                        const costPerSkein = yarnCost + dyeCostPerSkein + chemicalCostPerSkein + ballBandCost + labelCost;
                        
                        // Add each individual skein
                        for (let i = 0; i < quantity; i++) {
                            costs.skeinDetails.push({
                                base: yarnGroup.base,
                                hankSize: yarnGroup.hankSize,
                                cost: costPerSkein
                            });
                        }
                        
                        costs.yarn += yarnCost * quantity;
                        costs.ballBands += ballBandCost * quantity;
                        costs.labels += labelCost * quantity;
                    });
                }

                costs.total = costs.yarn + costs.dye + costs.chemicals + costs.ballBands + costs.labels;
                costs.perSkein = costs.skeins > 0 ? costs.total / costs.skeins : 0;

                return costs;
            };

            const markPanComplete = () => {
                if (currentPanIndex < selectedSession.pans.length - 1) {
                    setCurrentPanIndex(currentPanIndex + 1);
                } else {
                    if (confirm('All pans in this session are complete! Mark session as finished?')) {
                        finishSession();
                    }
                }
            };

            const finishSession = () => {
                if (!selectedSession) return;

                const confirmMessage = `Finish session "${selectedSession.name}"?\n\nThis will:\n- Create batches in Pipeline for each pan\n- Deduct yarn from inventory\n- Remove this session from Dye Sessions`;
                
                if (!confirm(confirmMessage)) return;

                // Create batches for each pan with yarn details and costs
                const newBatches = selectedSession.pans.map((pan, idx) => {
                    const recipe = pan.recipe || (pan.recipeId ? recipes.find(r => r.id === parseInt(pan.recipeId)) : null);
                    const costs = calculatePanCosts(pan, recipe);
                    
                    if (pan.type === 'gradientTray') {
                        return {
                            id: Date.now() + idx,
                            recipeId: '',
                            recipeName: `${pan.gradientDye} Gradient`,
                            colorway: `${pan.gradientDye} Gradient`,
                            customColorway: `${pan.gradientDye} Gradient`,
                            skeins: 10,
                            status: 'dyeing',
                            startDate: selectedSession.date,
                            notes: `Gradient tray from session: ${selectedSession.name}`,
                            yarnDetails: [{ base: pan.gradientYarnBase, hankSize: pan.gradientHankSize, quantity: 10 }],
                            costBreakdown: costs,
                            totalCost: costs.total,
                            costPerSkein: costs.perSkein
                        };
                    } else {
                        return {
                            id: Date.now() + idx,
                            recipeId: pan.recipeId || '',
                            recipeName: pan.recipe?.name || pan.colorway,
                            colorway: pan.colorway,
                            customColorway: pan.colorway,
                            skeins: pan.yarns.reduce((sum, y) => sum + parseInt(y.quantity || 0), 0),
                            status: 'dyeing',
                            startDate: selectedSession.date,
                            notes: `From session: ${selectedSession.name}`,
                            yarnDetails: pan.yarns,
                            costBreakdown: costs,
                            totalCost: costs.total,
                            costPerSkein: costs.perSkein
                        };
                    }
                });

                saveBatches([...batches, ...newBatches]);

                // Deduct yarn from inventory
                const updatedInventory = [...inventory];
                selectedSession.pans.forEach(pan => {
                    if (pan.type === 'gradientTray') {
                        // Deduct 10 skeins for gradient tray
                        const inventoryItem = updatedInventory.find(
                            item => item.category === 'yarn base' && 
                                    item.name === pan.gradientYarnBase && 
                                    parseFloat(item.hankSize) === parseFloat(pan.gradientHankSize)
                        );
                        if (inventoryItem) {
                            inventoryItem.quantity = Math.max(0, parseFloat(inventoryItem.quantity) - 10);
                        }
                    } else {
                        // Deduct regular pan yarns
                        pan.yarns.forEach(yarnInPan => {
                            const inventoryItem = updatedInventory.find(
                                item => item.category === 'yarn base' && 
                                        item.name === yarnInPan.base && 
                                        parseFloat(item.hankSize) === parseFloat(yarnInPan.hankSize)
                            );
                            
                            if (inventoryItem) {
                                const quantityToDeduct = parseInt(yarnInPan.quantity || 0);
                                inventoryItem.quantity = Math.max(0, parseFloat(inventoryItem.quantity) - quantityToDeduct);
                            }
                        });
                    }
                });
                saveInventory(updatedInventory);

                // Remove session from dyeSessions
                saveDyeSessions(dyeSessions.filter(s => s.id !== selectedSession.id));

                // Reset selection
                setCurrentPanIndex(0);
                setSelectedSessionId('');

                alert('Session completed! Batches added to Pipeline and inventory updated.');
            };

            const goToPreviousPan = () => {
                if (currentPanIndex > 0) {
                    setCurrentPanIndex(currentPanIndex - 1);
                }
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-gray-900">Up Next - Current Dye Session</h2>
                    </div>

                    {upcomingSessions.length === 0 ? (
                        <div className="bg-white rounded-lg card-shadow p-12 text-center">
                            <p className="text-xl text-gray-400 mb-4">ðŸ“…</p>
                            <p className="text-gray-600 mb-2">No upcoming dye sessions planned</p>
                            <p className="text-sm text-gray-500">Go to Dye Sessions to plan your next session!</p>
                        </div>
                    ) : (
                        <>
                            {/* Session Selector and Finish Button */}
                            <div className="bg-white rounded-lg card-shadow p-4">
                                <div className="flex gap-4 items-end">
                                    <div className="flex-1">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Active Session</label>
                                        <select
                                            value={selectedSessionId}
                                            onChange={(e) => {
                                                setSelectedSessionId(e.target.value);
                                                setCurrentPanIndex(0);
                                            }}
                                            className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500 text-lg font-medium"
                                        >
                                            {upcomingSessions.map(session => (
                                                <option key={session.id} value={session.id}>
                                                    {session.name} - {new Date(session.date).toLocaleDateString()} ({session.pans.length} pans)
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    <button
                                        onClick={finishSession}
                                        className="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-medium whitespace-nowrap"
                                    >
                                        ðŸ Finish Session
                                    </button>
                                </div>
                            </div>

                            {selectedSession && currentPan && (
                                <>
                                    {/* Progress Bar */}
                                    <div className="bg-white rounded-lg card-shadow p-4">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-sm font-medium text-gray-700">
                                                Pan {currentPanIndex + 1} of {selectedSession.pans.length}
                                            </span>
                                            <span className="text-sm text-gray-500">
                                                {Math.round(((currentPanIndex + 1) / selectedSession.pans.length) * 100)}% Complete
                                            </span>
                                        </div>
                                        <div className="w-full bg-gray-200 rounded-full h-3">
                                            <div 
                                                className="bg-purple-600 h-3 rounded-full transition-all"
                                                style={{ width: `${((currentPanIndex + 1) / selectedSession.pans.length) * 100}%` }}
                                            />
                                        </div>
                                    </div>

                                    {/* Current Pan/Tray Details */}
                                    <div className="bg-gradient-to-br from-purple-50 to-blue-50 rounded-lg card-shadow p-6 border-2 border-purple-300">
                                        {currentPan.type === 'gradientTray' ? (
                                            // Gradient Tray Display
                                            <>
                                                <div className="mb-4">
                                                    <div className="flex gap-4 items-start">
                                                        <div 
                                                            className="w-32 h-32 rounded-lg border-2 flex items-center justify-center flex-shrink-0"
                                                            style={{
                                                                background: `linear-gradient(to right, ${(() => {
                                                                    const dye = inventory.find(i => i.name === currentPan.gradientDye);
                                                                    return dye?.color || '#9333ea';
                                                                })()}15, ${(() => {
                                                                    const dye = inventory.find(i => i.name === currentPan.gradientDye);
                                                                    return dye?.color || '#9333ea';
                                                                })()}60, ${(() => {
                                                                    const dye = inventory.find(i => i.name === currentPan.gradientDye);
                                                                    return dye?.color || '#9333ea';
                                                                })()})`
                                                            }}
                                                        >
                                                            <span className="text-5xl">ðŸŽ¨</span>
                                                        </div>
                                                        <div className="flex-1">
                                                            <h3 className="text-2xl font-bold text-gray-900 mb-1">
                                                                ðŸŽ¨ Gradient Tray - {currentPan.gradientDye}
                                                            </h3>
                                                            <p className="text-purple-700 font-medium mb-2">
                                                                Tray #{currentPanIndex + 1} â€¢ 10 colors â€¢ {currentPan.gradientYarnBase} ({currentPan.gradientHankSize}g)
                                                            </p>
                                                            <div className="flex gap-1 mt-2 flex-wrap">
                                                                {currentPan.depths.map((depth, i) => (
                                                                    <div key={i} className="text-xs bg-white px-2 py-1 rounded border font-medium">
                                                                        {depth}%
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {/* Navigation buttons for gradient tray */}
                                                <div className="flex gap-3 w-full">
                                                    <button
                                                        onClick={goToPreviousPan}
                                                        disabled={currentPanIndex === 0}
                                                        style={{
                                                            backgroundColor: currentPanIndex === 0 ? '#d1d5db' : '#9333ea',
                                                            color: currentPanIndex === 0 ? '#9ca3af' : '#ffffff',
                                                            cursor: currentPanIndex === 0 ? 'not-allowed' : 'pointer'
                                                        }}
                                                        className="flex-1 px-6 py-3 rounded-lg font-semibold text-lg transition-colors shadow-md"
                                                    >
                                                        â† Previous
                                                    </button>
                                                    <button
                                                        onClick={markPanComplete}
                                                        style={{ backgroundColor: '#16a34a', color: '#ffffff' }}
                                                        className="flex-1 px-6 py-3 rounded-lg font-semibold text-lg transition-colors shadow-md"
                                                    >
                                                        {currentPanIndex < selectedSession.pans.length - 1 ? 'Next â†’' : 'Complete Session âœ“'}
                                                    </button>
                                                </div>
                                            </>
                                        ) : (
                                            // Regular Pan Display
                                            <>
                                        <div className="mb-4">
                                            <div className="flex justify-between items-start gap-4 mb-4">
                                                <div className="flex gap-4 items-start flex-1">
                                                    {currentRecipe?.photo && (
                                                        <img 
                                                            src={currentRecipe.photo} 
                                                            alt={currentPan.colorway}
                                                            className="rounded-lg border-2 border-purple-300 shadow-md flex-shrink-0"
                                                            style={{width: '120px', height: '120px', objectFit: 'cover'}}
                                                        />
                                                    )}
                                                    <div className="flex-1">
                                                        <h3 className="text-2xl font-bold text-gray-900 mb-1">
                                                            ðŸŽ¨ {currentPan.colorway}
                                                        </h3>
                                                        <p className="text-purple-700 font-medium mb-2">
                                                            Pan #{currentPanIndex + 1} â€¢ {currentPan.totalWeight}g total
                                                        </p>
                                                        {currentRecipe?.colorType && (
                                                            <p className="text-sm text-gray-700">
                                                                <span className="font-medium">Color Type:</span> <span className="capitalize">{currentRecipe.colorType}</span>
                                                            </p>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {/* Navigation Buttons - Full Width Row */}
                                            <div className="flex gap-3 w-full">
                                                <button
                                                    onClick={goToPreviousPan}
                                                    disabled={currentPanIndex === 0}
                                                    style={{
                                                        backgroundColor: currentPanIndex === 0 ? '#d1d5db' : '#9333ea',
                                                        color: currentPanIndex === 0 ? '#9ca3af' : '#ffffff',
                                                        cursor: currentPanIndex === 0 ? 'not-allowed' : 'pointer'
                                                    }}
                                                    className="flex-1 px-6 py-3 rounded-lg font-semibold text-lg transition-colors shadow-md"
                                                    onMouseEnter={(e) => {
                                                        if (currentPanIndex !== 0) {
                                                            e.target.style.backgroundColor = '#7e22ce';
                                                        }
                                                    }}
                                                    onMouseLeave={(e) => {
                                                        if (currentPanIndex !== 0) {
                                                            e.target.style.backgroundColor = '#9333ea';
                                                        }
                                                    }}
                                                >
                                                    â† Previous Pan
                                                </button>
                                                <button
                                                    onClick={markPanComplete}
                                                    style={{
                                                        backgroundColor: '#16a34a',
                                                        color: '#ffffff'
                                                    }}
                                                    className="flex-1 px-6 py-3 rounded-lg font-semibold text-lg transition-colors shadow-md"
                                                    onMouseEnter={(e) => {
                                                        e.target.style.backgroundColor = '#15803d';
                                                    }}
                                                    onMouseLeave={(e) => {
                                                        e.target.style.backgroundColor = '#16a34a';
                                                    }}
                                                >
                                                    {currentPanIndex < selectedSession.pans.length - 1 ? 'Next Pan â†’' : 'Complete Session âœ“'}
                                                </button>
                                            </div>
                                        </div>

                                        {/* Instructions */}
                                        {currentRecipe?.instructions && (
                                            <div className="bg-white rounded-lg p-4 mb-4">
                                                <h4 className="font-semibold text-gray-900 mb-2">Instructions:</h4>
                                                <p className="text-gray-700 whitespace-pre-line">{currentRecipe.instructions}</p>
                                            </div>
                                        )}

                                        {/* Yarns in Pan */}
                                        <div className="bg-white rounded-lg p-4 mb-4">
                                            <h4 className="font-semibold text-gray-900 mb-3">Yarns in This Pan:</h4>
                                            <div className="space-y-2">
                                                {currentPan.yarns.map((yarn, idx) => (
                                                    <div key={idx} className="flex justify-between items-center p-3 bg-purple-50 rounded border-l-4 border-purple-500">
                                                        <span className="font-medium">
                                                            {yarn.quantity}x {yarn.base} ({yarn.hankSize}g each)
                                                        </span>
                                                        <span className="text-purple-700 font-semibold">
                                                            {yarn.quantity * parseFloat(yarn.hankSize)}g total
                                                        </span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        {/* Recipe & Scaled Ingredients */}
                                        {currentRecipe ? (
                                            <div className="bg-white rounded-lg p-4">
                                                <h4 className="font-semibold text-gray-900 mb-3">
                                                    Recipe: {currentRecipe.name}
                                                    <span className="text-sm text-gray-500 ml-2">
                                                        (scaled from {currentRecipe.yarnWeight}g to {currentPan.totalWeight}g)
                                                    </span>
                                                </h4>
                                                <div className="space-y-2">
                                                    {currentRecipe.colorType === 'variegated' ? (
                                                        // Display scaled color solutions
                                                        scaleIngredients(currentRecipe, currentPan.totalWeight).map((solution, idx) => (
                                                            <div key={idx} className="border-2 border-purple-200 rounded-lg p-3 bg-purple-50">
                                                                <div className="font-semibold text-purple-900 mb-2">
                                                                    {solution.name || `Solution ${idx + 1}`}
                                                                    {solution.scaledTargetMl && (
                                                                        <span className="text-sm font-normal text-gray-600 ml-2">
                                                                            â†’ Add water to {solution.scaledTargetMl}ml
                                                                        </span>
                                                                    )}
                                                                </div>
                                                                <div className="space-y-1 pl-3">
                                                                    {solution.dyes.map((dye, dIdx) => (
                                                                        <div key={dIdx} className="flex justify-between items-center">
                                                                            <span className="text-sm text-gray-700">â€¢ {dye.name}</span>
                                                                            <span className="text-blue-700 font-bold">
                                                                                {dye.scaledAmount}{dye.unit}
                                                                                <span className="text-xs text-gray-500 ml-1">
                                                                                    (orig: {dye.amount}{dye.unit})
                                                                                </span>
                                                                            </span>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        ))
                                                    ) : (
                                                        // Display regular scaled ingredients
                                                        scaleIngredients(currentRecipe, currentPan.totalWeight).map((ing, idx) => (
                                                            <div key={idx} className="flex justify-between items-center p-3 bg-blue-50 rounded">
                                                                <span className="font-medium text-gray-900">{ing.name}</span>
                                                                <div className="text-right">
                                                                    <span className="text-blue-700 font-bold text-lg">
                                                                        {ing.scaledAmount}{ing.unit}
                                                                    </span>
                                                                    <span className="text-xs text-gray-500 ml-2">
                                                                        (original: {ing.amount}{ing.unit})
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        ))
                                                    )}
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
                                                <p className="text-yellow-800">
                                                    âš ï¸ No recipe linked to this pan. Ingredients need to be calculated manually.
                                                </p>
                                            </div>
                                        )}
                                        </>
                                        )}

                                        {/* Cost Breakdown */}
                                        {(() => {
                                            const costs = calculatePanCosts(currentPan, currentRecipe);
                                            return (
                                                <div className="bg-green-50 border-2 border-green-300 rounded-lg p-4 mt-4">
                                                    <h4 className="font-semibold text-green-900 mb-3">ðŸ’° Cost Breakdown</h4>
                                                    <div className="grid grid-cols-2 gap-2 text-sm mb-3">
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-700">Yarn:</span>
                                                            <span className="font-medium">${costs.yarn.toFixed(2)}</span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-700">Dye:</span>
                                                            <span className="font-medium">${costs.dye.toFixed(2)}</span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-700">Chemicals:</span>
                                                            <span className="font-medium">${costs.chemicals.toFixed(2)}</span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-700">Ball Bands:</span>
                                                            <span className="font-medium">${costs.ballBands.toFixed(2)}</span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-700">Labels:</span>
                                                            <span className="font-medium">${costs.labels.toFixed(2)}</span>
                                                        </div>
                                                    </div>
                                                    <div className="border-t-2 border-green-400 pt-2">
                                                        <div className="flex justify-between items-center">
                                                            <span className="font-bold text-green-900">Total Cost:</span>
                                                            <span className="font-bold text-xl text-green-900">${costs.total.toFixed(2)}</span>
                                                        </div>
                                                        <div className="flex justify-between items-center mt-1">
                                                            <span className="text-sm text-gray-700">Average ({costs.skeins} skeins):</span>
                                                            <span className="font-semibold text-green-800">${costs.perSkein.toFixed(2)}/skein</span>
                                                        </div>
                                                        
                                                        {/* Per-skein details grouped by base+size */}
                                                        {costs.skeinDetails && costs.skeinDetails.length > 0 && (() => {
                                                            // Group by base+hankSize
                                                            const grouped = costs.skeinDetails.reduce((acc, skein) => {
                                                                const key = `${skein.base} ${skein.hankSize}g`;
                                                                if (!acc[key]) {
                                                                    acc[key] = { count: 0, cost: skein.cost };
                                                                }
                                                                acc[key].count++;
                                                                return acc;
                                                            }, {});
                                                            
                                                            return (
                                                                <div className="mt-3 pt-2 border-t border-green-300">
                                                                    <div className="text-xs font-semibold text-green-900 mb-1">Cost per skein type:</div>
                                                                    {Object.entries(grouped).map(([key, {count, cost}]) => (
                                                                        <div key={key} className="flex justify-between text-xs text-gray-700">
                                                                            <span>{count}x {key}:</span>
                                                                            <span className="font-medium">${cost.toFixed(2)} each</span>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            );
                                                        })()}
                                                    </div>
                                                </div>
                                            );
                                        })()}
                                    </div>

                                    {/* Upcoming Pans Preview */}
                                    {currentPanIndex < selectedSession.pans.length - 1 && (
                                        <div className="bg-white rounded-lg card-shadow p-4">
                                            <h4 className="font-semibold text-gray-700 mb-3">Coming Up Next:</h4>
                                            <div className="space-y-2">
                                                {selectedSession.pans.slice(currentPanIndex + 1, currentPanIndex + 4).map((pan, idx) => (
                                                    <div key={pan.id} className="flex justify-between items-center p-3 bg-gray-50 rounded border">
                                                        <div>
                                                            <span className="font-medium text-gray-900">
                                                                Pan #{currentPanIndex + idx + 2}: {pan.colorway}
                                                            </span>
                                                            <span className="text-sm text-gray-500 ml-2">
                                                                ({pan.totalWeight}g)
                                                            </span>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </>
                            )}
                        </>
                    )}
                </div>
            );
        }

        // Inventory Component
        function Inventory({ inventory, saveInventory, settings }) {
            const [showForm, setShowForm] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [filterCategory, setFilterCategory] = useState('all');
            const [formData, setFormData] = useState({
                name: '',
                category: 'dye',
                quantity: '',
                unit: 'oz',
                hankSize: '',
                lowStockThreshold: '',
                cost: '',
                purchasePrice: '',
                purchaseOunces: '',
                supplier: '',
                color: '',
                image: '',
                notes: '',
                // Yarn base specific fields
                myYarnName: '',
                fiberContent: '',
                yardage: '',
                presentation: '',
                needleSize: '',
                gauge: '',
                wpi: '',
                plies: '',
                weight: ''
            });

            const categories = settings.inventoryCategories || ['dye', 'yarn base', 'chemical', 'tool', 'other'];

            const handleSubmit = (e) => {
                e.preventDefault();
                if (editingId) {
                    saveInventory(inventory.map(i => i.id === editingId ? { ...formData, id: editingId } : i));
                } else {
                    saveInventory([...inventory, { ...formData, id: Date.now() }]);
                }
                resetForm();
            };

            const resetForm = () => {
                setFormData({
                    name: '',
                    category: 'dye',
                    quantity: '',
                    unit: 'oz',
                    lowStockThreshold: '',
                    cost: '',
                    purchasePrice: '',
                    purchaseOunces: '',
                    supplier: '',
                    color: '',
                    image: '',
                    notes: '',
                    myYarnName: '',
                    fiberContent: '',
                    yardage: '',
                    presentation: '',
                    needleSize: '',
                    gauge: '',
                    wpi: '',
                    plies: '',
                    weight: ''
                });
                setShowForm(false);
                setEditingId(null);
            };

            const editItem = (item) => {
                setFormData(item);
                setEditingId(item.id);
                setShowForm(true);
            };

            const deleteItem = (id) => {
                if (confirm('Delete this item?')) {
                    saveInventory(inventory.filter(i => i.id !== id));
                }
            };

            const adjustQuantity = (id, delta) => {
                saveInventory(inventory.map(i => 
                    i.id === id ? { ...i, quantity: Math.max(0, parseFloat(i.quantity) + delta) } : i
                ));
            };

            const filteredInventory = (filterCategory === 'all' 
                ? inventory 
                : inventory.filter(i => i.category === filterCategory)
            ).sort((a, b) => a.name.localeCompare(b.name));

            const lowStockItems = inventory.filter(i => 
                i.lowStockThreshold != null && 
                i.lowStockThreshold !== '' && 
                i.quantity <= i.lowStockThreshold
            );

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-gray-900">Inventory Management</h2>
                        <button
                            onClick={() => setShowForm(!showForm)}
                            className="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors font-medium"
                        >
                            {showForm ? 'âœ• Cancel' : '+ Add Item'}
                        </button>
                    </div>

                    {/* Low Stock Alert */}
                    {lowStockItems.length > 0 && !showForm && (
                        <div className="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                            <p className="font-semibold text-red-800">âš ï¸ {lowStockItems.length} item(s) running low!</p>
                        </div>
                    )}

                    {/* Category Filter */}
                    <div className="flex gap-2 overflow-x-auto pb-2">
                        <button
                            onClick={() => setFilterCategory('all')}
                            className={`px-4 py-2 rounded-lg font-medium whitespace-nowrap ${
                                filterCategory === 'all' 
                                    ? 'bg-purple-600 text-white' 
                                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                            }`}
                        >
                            All ({inventory.length})
                        </button>
                        {categories.map(cat => (
                            <button
                                key={cat}
                                onClick={() => setFilterCategory(cat)}
                                className={`px-4 py-2 rounded-lg font-medium whitespace-nowrap capitalize ${
                                    filterCategory === cat 
                                        ? 'bg-purple-600 text-white' 
                                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                }`}
                            >
                                {cat} ({inventory.filter(i => i.category === cat).length})
                            </button>
                        ))}
                    </div>

                    {/* Form Modal */}
                    {showForm && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={resetForm}>
                            <div className="bg-white rounded-lg card-shadow max-w-4xl w-full max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                                <div className="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                                    <h3 className="text-xl font-semibold">{editingId ? 'Edit Item' : 'New Item'}</h3>
                                    <button
                                        onClick={resetForm}
                                        className="text-gray-500 hover:text-gray-700 text-2xl"
                                    >
                                        âœ•
                                    </button>
                                </div>
                                <div className="p-6">
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div className="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Item Name *</label>
                                        <input
                                            type="text"
                                            required
                                            value={formData.name}
                                            onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                            placeholder="e.g., Acid Blue 113 or Luna DK"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Category *</label>
                                        <select
                                            required
                                            value={formData.category}
                                            onChange={(e) => {
                                                const newCategory = e.target.value;
                                                let defaultUnit = formData.unit;
                                                
                                                // Set default units based on category
                                                if (newCategory === 'yarn base') {
                                                    defaultUnit = 'skeins';
                                                } else if (newCategory === 'dye') {
                                                    defaultUnit = 'oz';
                                                }
                                                
                                                setFormData({ ...formData, category: newCategory, unit: defaultUnit });
                                            }}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                        >
                                            {categories.map(cat => (
                                                <option key={cat} value={cat} className="capitalize">{cat}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>

                                {formData.category === 'yarn base' && (
                                    <>
                                        <div className="grid md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Supplier Name</label>
                                                <input
                                                    type="text"
                                                    value={formData.name}
                                                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                    placeholder="e.g., W2D4 Merino DK SW"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">My Name for Yarn</label>
                                                <input
                                                    type="text"
                                                    value={formData.myYarnName}
                                                    onChange={(e) => setFormData({ ...formData, myYarnName: e.target.value })}
                                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                    placeholder="e.g., Luna DK"
                                                />
                                            </div>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Hank/Skein Size (g)</label>
                                            <input
                                                type="number"
                                                step="0.1"
                                                value={formData.hankSize}
                                                onChange={(e) => setFormData({ ...formData, hankSize: e.target.value })}
                                                className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                placeholder="e.g., 20, 50, 100"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Typical Sale Price (per skein)</label>
                                            <input
                                                type="number"
                                                step="0.01"
                                                value={formData.typicalPrice}
                                                onChange={(e) => setFormData({ ...formData, typicalPrice: e.target.value })}
                                                className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                placeholder="e.g., 25.00"
                                            />
                                            <p className="text-xs text-gray-500 mt-1">Default selling price for this yarn/size combination</p>
                                        </div>

                                        <div className="grid md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Fiber Content</label>
                                                <input
                                                    type="text"
                                                    value={formData.fiberContent}
                                                    onChange={(e) => setFormData({ ...formData, fiberContent: e.target.value })}
                                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                    placeholder="e.g., 100% Superwash Merino Wool"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Yardage</label>
                                                <input
                                                    type="text"
                                                    value={formData.yardage}
                                                    onChange={(e) => setFormData({ ...formData, yardage: e.target.value })}
                                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                    placeholder="e.g., 109yds per skein"
                                                />
                                            </div>
                                        </div>

                                        <div className="grid md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Presentation</label>
                                                <input
                                                    type="text"
                                                    value={formData.presentation}
                                                    onChange={(e) => setFormData({ ...formData, presentation: e.target.value })}
                                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                    placeholder="e.g., 10 x 100g skeins"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Weight Category</label>
                                                <input
                                                    type="text"
                                                    value={formData.weight}
                                                    onChange={(e) => setFormData({ ...formData, weight: e.target.value })}
                                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                    placeholder="e.g., Bulky, DK, Fingering"
                                                />
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-12 gap-2">
                                            <div className="col-span-2">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Needle Size</label>
                                                <input
                                                    type="text"
                                                    value={formData.needleSize}
                                                    onChange={(e) => setFormData({ ...formData, needleSize: e.target.value })}
                                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                    placeholder="#9"
                                                />
                                            </div>
                                            <div className="col-span-6">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Gauge</label>
                                                <input
                                                    type="text"
                                                    value={formData.gauge}
                                                    onChange={(e) => setFormData({ ...formData, gauge: e.target.value })}
                                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                    placeholder="14 sts & 24 rows"
                                                />
                                            </div>
                                            <div className="col-span-2">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">WPI</label>
                                                <input
                                                    type="text"
                                                    value={formData.wpi}
                                                    onChange={(e) => setFormData({ ...formData, wpi: e.target.value })}
                                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                    placeholder="10"
                                                    maxLength="2"
                                                />
                                            </div>
                                            <div className="col-span-2">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Plies</label>
                                                <input
                                                    type="text"
                                                    value={formData.plies}
                                                    onChange={(e) => setFormData({ ...formData, plies: e.target.value })}
                                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                    placeholder="3"
                                                    maxLength="2"
                                                />
                                            </div>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Yarn Image (URL)</label>
                                            <input
                                                type="text"
                                                value={formData.image}
                                                onChange={(e) => setFormData({ ...formData, image: e.target.value })}
                                                className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                placeholder="https://example.com/yarn-image.jpg"
                                            />
                                            {formData.image && (
                                                <img 
                                                    src={formData.image} 
                                                    alt="Yarn preview" 
                                                    className="mt-2 h-6 w-auto border rounded"
                                                    onError={(e) => e.target.style.display = 'none'}
                                                />
                                            )}
                                        </div>
                                    </>
                                )}

                                {formData.category === 'ball band' && (
                                    <>
                                        <div className="grid md:grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">For Yarn Base *</label>
                                                <select
                                                    value={formData.forYarnBase || ''}
                                                    onChange={(e) => setFormData({ ...formData, forYarnBase: e.target.value })}
                                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                >
                                                    <option value="">Select yarn base...</option>
                                                    {inventory.filter(i => i.category === 'yarn base').map(yarn => (
                                                        <option key={yarn.id} value={yarn.name}>{yarn.name}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Hank Size (g) *</label>
                                                <input
                                                    type="number"
                                                    value={formData.hankSize || ''}
                                                    onChange={(e) => setFormData({ ...formData, hankSize: e.target.value })}
                                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                    placeholder="e.g., 20, 50, 100"
                                                />
                                            </div>
                                        </div>
                                    </>
                                )}

                                <div className="grid md:grid-cols-3 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Quantity *</label>
                                        <input
                                            type="number"
                                            step="0.01"
                                            required
                                            value={formData.quantity}
                                            onChange={(e) => setFormData({ ...formData, quantity: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Unit *</label>
                                        <select
                                            value={formData.unit}
                                            onChange={(e) => {
                                                const newUnit = e.target.value;
                                                let newQuantity = formData.quantity;
                                                
                                                // Convert between oz/lb/g for dyes
                                                if (formData.category === 'dye' && formData.quantity) {
                                                    const qty = parseFloat(formData.quantity);
                                                    const oldUnit = formData.unit;
                                                    
                                                    // Convert to grams first
                                                    let grams = qty;
                                                    if (oldUnit === 'oz') grams = qty * 28.3495;
                                                    else if (oldUnit === 'lb') grams = qty * 453.592;
                                                    
                                                    // Convert from grams to new unit
                                                    if (newUnit === 'g') newQuantity = grams.toFixed(2);
                                                    else if (newUnit === 'oz') newQuantity = (grams / 28.3495).toFixed(2);
                                                    else if (newUnit === 'lb') newQuantity = (grams / 453.592).toFixed(4);
                                                }
                                                
                                                setFormData({ ...formData, unit: newUnit, quantity: newQuantity });
                                            }}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                        >
                                            <option value="g">grams (g)</option>
                                            <option value="oz">ounces (oz)</option>
                                            <option value="lb">pounds (lb)</option>
                                            <option value="kg">kilograms (kg)</option>
                                            <option value="ml">milliliters (ml)</option>
                                            <option value="L">liters (L)</option>
                                            <option value="skeins">skeins</option>
                                            <option value="units">units</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Low Stock Alert</label>
                                        <input
                                            type="number"
                                            step="0.01"
                                            value={formData.lowStockThreshold}
                                            onChange={(e) => setFormData({ ...formData, lowStockThreshold: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                            placeholder="Min qty"
                                        />
                                    </div>
                                </div>

                                <div className="grid md:grid-cols-2 gap-4">
                                    {formData.category === 'dye' ? (
                                        <>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Purchase Price ($)</label>
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    value={formData.purchasePrice}
                                                    onChange={(e) => {
                                                        const price = e.target.value;
                                                        setFormData({ ...formData, purchasePrice: price });
                                                        // Auto-calculate cost per gram if both fields are filled
                                                        if (price && formData.purchaseOunces) {
                                                            const costPerOz = parseFloat(price) / parseFloat(formData.purchaseOunces);
                                                            const costPerGram = costPerOz / 28.3495;
                                                            setFormData({ 
                                                                ...formData, 
                                                                purchasePrice: price,
                                                                cost: costPerGram.toFixed(4)
                                                            });
                                                        }
                                                    }}
                                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                    placeholder="e.g., 67.05"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Ounces Purchased</label>
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    value={formData.purchaseOunces}
                                                    onChange={(e) => {
                                                        const ounces = e.target.value;
                                                        setFormData({ ...formData, purchaseOunces: ounces });
                                                        // Auto-calculate cost per gram if both fields are filled
                                                        if (formData.purchasePrice && ounces) {
                                                            const costPerOz = parseFloat(formData.purchasePrice) / parseFloat(ounces);
                                                            const costPerGram = costPerOz / 28.3495;
                                                            setFormData({ 
                                                                ...formData, 
                                                                purchaseOunces: ounces,
                                                                cost: costPerGram.toFixed(4)
                                                            });
                                                        }
                                                    }}
                                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                    placeholder="e.g., 16"
                                                />
                                                {formData.purchasePrice && formData.purchaseOunces && (
                                                    <div className="text-xs text-green-600 mt-1">
                                                        Cost per gram: ${formData.cost}
                                                    </div>
                                                )}
                                            </div>
                                        </>
                                    ) : (
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Cost per Unit</label>
                                            <input
                                                type="number"
                                                step="0.01"
                                                value={formData.cost}
                                                onChange={(e) => setFormData({ ...formData, cost: e.target.value })}
                                                className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                placeholder="$"
                                            />
                                        </div>
                                    )}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Supplier</label>
                                        <select
                                            value={formData.supplier}
                                            onChange={(e) => setFormData({ ...formData, supplier: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                        >
                                            <option value="">Select supplier...</option>
                                            {(settings.suppliers || ['Dharma', 'Wool2Dye4', 'Amazon']).map(supplier => (
                                                <option key={supplier} value={supplier}>{supplier}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>

                                {formData.category === 'dye' && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Dye Color (Hex Code)
                                            <span className="text-xs text-gray-500 ml-2">e.g., #FF5733 or #3B82F6</span>
                                        </label>
                                        <div className="flex gap-2">
                                            <input
                                                type="text"
                                                value={formData.color}
                                                onChange={(e) => setFormData({ ...formData, color: e.target.value })}
                                                className="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                                placeholder="#FF5733"
                                                pattern="^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$"
                                            />
                                            <input
                                                type="color"
                                                value={formData.color || '#000000'}
                                                onChange={(e) => setFormData({ ...formData, color: e.target.value })}
                                                className="w-16 h-10 border rounded-lg cursor-pointer"
                                            />
                                        </div>
                                    </div>
                                )}

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                                    <textarea
                                        value={formData.notes}
                                        onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                                        rows="2"
                                        className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                    />
                                </div>

                                <div className="flex gap-3 pt-4">
                                    <button
                                        type="submit"
                                        className="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors font-medium"
                                    >
                                        {editingId ? 'Update Item' : 'Add Item'}
                                    </button>
                                    <button
                                        type="button"
                                        onClick={resetForm}
                                        className="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-300 transition-colors font-medium"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                            </div>
                        </div>
                    )}

                    {/* Inventory Table */}
                    <div className="bg-white rounded-lg card-shadow overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-gray-50 border-b">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Item</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quantity</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cost</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Supplier</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {filteredInventory.map(item => {
                                        const isLowStock = item.lowStockThreshold != null && 
                                                          item.lowStockThreshold !== '' && 
                                                          item.quantity <= item.lowStockThreshold;
                                        return (
                                            <tr key={item.id} className={isLowStock ? 'bg-red-50' : 'hover:bg-gray-50'}>
                                                <td className="px-6 py-4">
                                                    <div className="flex items-center gap-2">
                                                        {item.category === 'dye' && item.color && (
                                                            <div 
                                                                className="w-6 h-6 rounded-full border-2 border-gray-300 flex-shrink-0"
                                                                style={{ backgroundColor: item.color }}
                                                                title={`Color: ${item.color}`}
                                                            ></div>
                                                        )}
                                                        {item.category === 'yarn base' && item.image && (
                                                            <img 
                                                                src={item.image} 
                                                                alt={item.name}
                                                                style={{ 
                                                                    width: '125px !important', 
                                                                    height: '125px !important', 
                                                                    minWidth: '125px', 
                                                                    minHeight: '125px',
                                                                    maxWidth: '125px',
                                                                    maxHeight: '125px',
                                                                    objectFit: 'cover',
                                                                    borderRadius: '4px',
                                                                    border: '1px solid #d1d5db',
                                                                    flexShrink: 0
                                                                }}
                                                                onError={(e) => e.target.style.display = 'none'}
                                                            />
                                                        )}
                                                        <div>
                                                            <div className="font-medium text-gray-900">
                                                                {item.category === 'yarn base' && item.myYarnName 
                                                                    ? item.myYarnName 
                                                                    : item.name
                                                                }
                                                            </div>
                                                            {item.category === 'yarn base' && item.myYarnName && (
                                                                <div className="text-xs text-gray-500">({item.name})</div>
                                                            )}
                                                            {item.hankSize && (
                                                                <div className="text-sm text-purple-600">{item.hankSize}g hanks</div>
                                                            )}
                                                            {item.category === 'yarn base' && (
                                                                <div className="text-xs text-gray-600 mt-1 space-y-0.5">
                                                                    {item.fiberContent && <div>ðŸ“¦ {item.fiberContent}</div>}
                                                                    {item.weight && <div>âš–ï¸ {item.weight}</div>}
                                                                    {item.yardage && <div>ðŸ“ {item.yardage}</div>}
                                                                    {item.presentation && <div>ðŸŽ {item.presentation}</div>}
                                                                    {item.needleSize && <div>ðŸª¡ Needle: {item.needleSize}</div>}
                                                                    {item.gauge && <div>ðŸ“ Gauge: {item.gauge}</div>}
                                                                    {item.wpi && <div>ðŸ§µ WPI: {item.wpi}</div>}
                                                                    {item.plies && <div>ðŸ”— Plies: {item.plies}</div>}
                                                                </div>
                                                            )}
                                                            {item.notes && (
                                                                <div className="text-sm text-gray-500">{item.notes}</div>
                                                            )}
                                                        </div>
                                                    </div>
                                                </td>
                                                <td className="px-6 py-4 text-sm capitalize">{item.category}</td>
                                                <td className="px-6 py-4">
                                                    <div className="flex items-center gap-2">
                                                        <button
                                                            onClick={() => adjustQuantity(item.id, -1)}
                                                            className="w-6 h-6 flex items-center justify-center bg-gray-200 hover:bg-gray-300 rounded"
                                                        >
                                                            -
                                                        </button>
                                                        <span className={`font-medium ${isLowStock ? 'text-red-600' : ''}`}>
                                                            {item.unit === 'oz' 
                                                                ? `${(parseFloat(item.quantity) * 28.3495).toFixed(2)} g` 
                                                                : `${item.quantity} ${item.unit}`
                                                            }
                                                        </span>
                                                        <button
                                                            onClick={() => adjustQuantity(item.id, 1)}
                                                            className="w-6 h-6 flex items-center justify-center bg-gray-200 hover:bg-gray-300 rounded"
                                                        >
                                                            +
                                                        </button>
                                                    </div>
                                                    {isLowStock && (
                                                        <div className="text-xs text-red-600 mt-1">
                                                            âš ï¸ Below {item.unit === 'oz' 
                                                                ? `${(parseFloat(item.lowStockThreshold) * 28.3495).toFixed(2)} g`
                                                                : `${item.lowStockThreshold} ${item.unit}`
                                                            }
                                                        </div>
                                                    )}
                                                </td>
                                                <td className="px-6 py-4 text-sm">
                                                    {item.cost ? (() => {
                                                        const cost = parseFloat(item.cost);
                                                        const unit = item.unit || 'g';
                                                        
                                                        // For yarn bases, show per-skein cost
                                                        if (item.category === 'yarn base') {
                                                            return `$${cost.toFixed(2)}/skein`;
                                                        }
                                                        
                                                        // For ball bands and items with "units", show per-unit cost
                                                        if (item.category === 'ball band' || unit === 'units') {
                                                            return `$${cost.toFixed(2)}/unit`;
                                                        }
                                                        
                                                        // For skeins (non-yarn base), show per-skein cost
                                                        if (unit === 'skeins') {
                                                            return `$${cost.toFixed(2)}/skein`;
                                                        }
                                                        
                                                        // For weight/volume units, show entered unit and calculate per gram
                                                        let costPerGram = cost;
                                                        
                                                        // Convert to cost per gram
                                                        if (unit === 'oz') {
                                                            costPerGram = cost / 28.3495;
                                                        } else if (unit === 'lb') {
                                                            costPerGram = cost / 453.592;
                                                        } else if (unit === 'kg') {
                                                            costPerGram = cost / 1000;
                                                        } else if (unit === 'ml' || unit === 'L') {
                                                            // Liquids: assume 1ml = 1g
                                                            if (unit === 'L') {
                                                                costPerGram = cost / 1000;
                                                            } else {
                                                                costPerGram = cost;
                                                            }
                                                        }
                                                        // g, tsp, tbsp stay as entered
                                                        
                                                        // Show both entered cost and per-gram cost (for weight/volume units only)
                                                        if (unit !== 'g' && unit !== 'ml' && unit !== 'tsp' && unit !== 'tbsp') {
                                                            return (
                                                                <div>
                                                                    <div>${cost.toFixed(2)}/{unit}</div>
                                                                    <div className="text-xs text-gray-500">(${costPerGram.toFixed(4)}/g)</div>
                                                                </div>
                                                            );
                                                        }
                                                        
                                                        return `$${cost.toFixed(4)}/${unit}`;
                                                    })() : '-'}
                                                </td>
                                                <td className="px-6 py-4 text-sm">{item.supplier || '-'}</td>
                                                <td className="px-6 py-4 text-right">
                                                    <button
                                                        onClick={() => editItem(item)}
                                                        className="text-blue-600 hover:text-blue-800 mr-3"
                                                    >
                                                        âœï¸
                                                    </button>
                                                    <button
                                                        onClick={() => deleteItem(item.id)}
                                                        className="text-red-600 hover:text-red-800"
                                                    >
                                                        ðŸ—‘ï¸
                                                    </button>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>

                        {filteredInventory.length === 0 && (
                            <div className="text-center py-12 text-gray-400">
                                <p className="text-xl mb-2">ðŸ“¦</p>
                                <p>No items in this category yet.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Pipeline Component
        function Pipeline({ batches, saveBatches, recipes, inventory, saveInventory, settings }) {
            const [showForm, setShowForm] = useState(false);
            const [formData, setFormData] = useState({
                recipeId: '',
                customColorway: '',
                skeins: '',
                status: 'dyeing',
                startDate: new Date().toISOString().split('T')[0],
                notes: ''
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                const recipe = recipes.find(r => r.id === parseInt(formData.recipeId));
                const newBatch = {
                    ...formData,
                    id: Date.now(),
                    recipeName: recipe?.name || 'Custom',
                    colorway: formData.customColorway || recipe?.name || 'Custom Colorway'
                };
                saveBatches([...batches, newBatch]);
                resetForm();
            };

            const resetForm = () => {
                setFormData({
                    recipeId: '',
                    customColorway: '',
                    skeins: '',
                    status: 'dyeing',
                    startDate: new Date().toISOString().split('T')[0],
                    notes: ''
                });
                setShowForm(false);
            };

            const updateStatus = (id, newStatus, oldStatus) => {
                const batch = batches.find(b => b.id === id);
                
                // If marking as sold, prompt for sale price and calculate profit
                if (newStatus === 'sold' && batch) {
                    // Calculate suggested price from typical yarn prices
                    let suggestedPrice = 0;
                    if (batch.yarnDetails && batch.yarnDetails.length > 0) {
                        batch.yarnDetails.forEach(yarn => {
                            const yarnItem = inventory.find(i => 
                                i.category === 'yarn base' && 
                                i.name === yarn.base && 
                                parseFloat(i.hankSize) === parseFloat(yarn.hankSize)
                            );
                            if (yarnItem?.typicalPrice) {
                                suggestedPrice += parseFloat(yarnItem.typicalPrice) * parseInt(yarn.quantity || 0);
                            }
                        });
                    }
                    
                    const promptMessage = suggestedPrice > 0 
                        ? `Enter total sale price for "${batch.colorway}" (${batch.skeins} skeins):\n\nSuggested price: $${suggestedPrice.toFixed(2)} (based on typical prices)`
                        : `Enter total sale price for "${batch.colorway}" (${batch.skeins} skeins):`;
                    
                    const salePrice = prompt(promptMessage, suggestedPrice > 0 ? suggestedPrice.toFixed(2) : '');
                    if (salePrice === null) return; // User cancelled
                    
                    const price = parseFloat(salePrice);
                    if (isNaN(price) || price < 0) {
                        alert('Please enter a valid price');
                        return;
                    }
                    
                    const cost = batch.totalCost || 0;
                    const profit = price - cost;
                    const pricePerSkein = batch.skeins > 0 ? price / batch.skeins : 0;
                    
                    // Update batch with sale info
                    const updatedBatch = {
                        ...batch,
                        status: 'sold',
                        salePrice: price,
                        pricePerSkein: pricePerSkein,
                        profit: profit,
                        profitMargin: cost > 0 ? ((profit / cost) * 100) : 0,
                        soldDate: new Date().toISOString().split('T')[0]
                    };
                    
                    saveBatches(batches.map(b => b.id === id ? updatedBatch : b));
                    
                    // Show profit summary
                    alert(`Sale recorded!\n\nSale Price: $${price.toFixed(2)}\nCost: $${cost.toFixed(2)}\nProfit: $${profit.toFixed(2)} (${updatedBatch.profitMargin.toFixed(1)}%)\nPer Skein: $${pricePerSkein.toFixed(2)}`);
                    
                    // Deduct ball bands if coming from ready
                    if (oldStatus === 'ready' && batch.yarnDetails && batch.yarnDetails.length > 0) {
                        const updatedInventory = [...inventory];
                        batch.yarnDetails.forEach(yarn => {
                            const quantity = parseInt(yarn.quantity || 0);
                            const hankSize = parseFloat(yarn.hankSize);
                            const yarnBase = yarn.base;
                            
                            // Find ball band that matches this yarn base AND hank size
                            const ballBand = updatedInventory.find(item => 
                                item.category === 'ball band' && 
                                item.forYarnBase === yarnBase &&
                                parseFloat(item.hankSize) === hankSize
                            );
                            if (ballBand) {
                                ballBand.quantity = Math.max(0, parseFloat(ballBand.quantity) - quantity);
                            }
                        });
                        saveInventory(updatedInventory);
                    }
                    return;
                }
                
                // Regular status update
                saveBatches(batches.map(b => b.id === id ? { ...b, status: newStatus } : b));
            };

            const deleteBatch = (id) => {
                if (confirm('Delete this batch?')) {
                    saveBatches(batches.filter(b => b.id !== id));
                }
            };

            const statuses = ['dyeing', 'drying', 'ready', 'sold'];
            const statusLabels = {
                dyeing: { label: 'Dyeing', color: 'yellow', emoji: 'ðŸŽ¨' },
                drying: { label: 'Drying', color: 'blue', emoji: 'ðŸ’¨' },
                ready: { label: 'Ready for Labels', color: 'green', emoji: 'âœ“' },
                sold: { label: 'Sold', color: 'gray', emoji: 'ðŸ’°' }
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-gray-900">Production Pipeline</h2>
                        <button
                            onClick={() => setShowForm(!showForm)}
                            className="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors font-medium"
                        >
                            {showForm ? 'âœ• Cancel' : '+ New Batch'}
                        </button>
                    </div>

                    {/* Form */}
                    {showForm && (
                        <div className="bg-white rounded-lg card-shadow p-6">
                            <h3 className="text-xl font-semibold mb-4">Start New Batch</h3>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div className="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Recipe</label>
                                        <select
                                            value={formData.recipeId}
                                            onChange={(e) => setFormData({ ...formData, recipeId: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                        >
                                            <option value="">Select a recipe (optional)</option>
                                            {recipes.map(r => (
                                                <option key={r.id} value={r.id}>
                                                    {r.name}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Custom Colorway Name</label>
                                        <input
                                            type="text"
                                            value={formData.customColorway}
                                            onChange={(e) => setFormData({ ...formData, customColorway: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                            placeholder="Override colorway name"
                                        />
                                    </div>
                                </div>

                                <div className="grid md:grid-cols-3 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Number of Skeins *</label>
                                        <input
                                            type="number"
                                            required
                                            value={formData.skeins}
                                            onChange={(e) => setFormData({ ...formData, skeins: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Initial Status</label>
                                        <select
                                            value={formData.status}
                                            onChange={(e) => setFormData({ ...formData, status: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                        >
                                            {statuses.filter(s => s !== 'sold').map(status => (
                                                <option key={status} value={status} className="capitalize">
                                                    {statusLabels[status].label}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                        <input
                                            type="date"
                                            value={formData.startDate}
                                            onChange={(e) => setFormData({ ...formData, startDate: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                                    <textarea
                                        value={formData.notes}
                                        onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                                        rows="2"
                                        className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                        placeholder="Any special notes about this batch..."
                                    />
                                </div>

                                <div className="flex gap-3 pt-4">
                                    <button
                                        type="submit"
                                        className="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors font-medium"
                                    >
                                        Start Batch
                                    </button>
                                    <button
                                        type="button"
                                        onClick={resetForm}
                                        className="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-300 transition-colors font-medium"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}

                    {/* Pipeline View */}
                    <div className="grid md:grid-cols-4 gap-4">
                        {statuses.map(status => {
                            const batchesInStatus = batches.filter(b => b.status === status);
                            const statusInfo = statusLabels[status];
                            
                            return (
                                <div key={status} className="bg-white rounded-lg card-shadow p-4">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="font-semibold text-gray-900">
                                            {statusInfo.emoji} {statusInfo.label}
                                        </h3>
                                        <span className="bg-gray-100 text-gray-700 px-2 py-1 rounded-full text-sm font-medium">
                                            {batchesInStatus.length}
                                        </span>
                                    </div>
                                    
                                    <div className="space-y-3">
                                        {batchesInStatus.map(batch => {
                                            // Get recipe image (either saved or look up from recipe)
                                            let recipeImageUrl = batch.recipeImageUrl;
                                            if (!recipeImageUrl && batch.recipeId) {
                                                const recipe = recipes.find(r => r.id === parseInt(batch.recipeId));
                                                recipeImageUrl = recipe?.photo; // Changed from imageUrl to photo
                                            }
                                            
                                            return (
                                            <div key={batch.id} className={`p-3 rounded-lg border-2 status-${status} flex gap-3`}>
                                                {/* Recipe image */}
                                                {recipeImageUrl && (
                                                    <img 
                                                        src={recipeImageUrl} 
                                                        alt={batch.colorway}
                                                        className="rounded object-cover flex-shrink-0"
                                                        style={{ width: '60px', height: '60px', minWidth: '60px', minHeight: '60px', maxWidth: '60px', maxHeight: '60px' }}
                                                        onError={(e) => e.target.style.display = 'none'}
                                                    />
                                                )}
                                                
                                                <div className="flex-1">
                                                    <div className="font-medium text-sm mb-1">{batch.colorway}</div>
                                                    
                                                    {/* Skein details */}
                                                    {batch.yarnDetails && batch.yarnDetails.length > 0 ? (
                                                        <div className="text-xs text-gray-600 mb-2">
                                                            {(() => {
                                                                const grouped = batch.yarnDetails.reduce((acc, yarn) => {
                                                                    const key = `${yarn.base} ${yarn.hankSize}g`;
                                                                    acc[key] = (acc[key] || 0) + parseInt(yarn.quantity || 1);
                                                                    return acc;
                                                                }, {});
                                                                return Object.entries(grouped).map(([key, qty]) => `${qty}x ${key}`).join(', ');
                                                            })()} â€¢ {new Date(batch.startDate).toLocaleDateString()}
                                                        </div>
                                                    ) : (
                                                        <div className="text-xs text-gray-600 mb-2">
                                                            {batch.skeins} skeins â€¢ {new Date(batch.startDate).toLocaleDateString()}
                                                        </div>
                                                    )}
                                                    
                                                    {batch.costPerSkein != null && batch.totalCost != null && (
  <div className="text-xs text-green-700 font-medium mb-1">
    ðŸ’° Cost: ${Number(batch.costPerSkein).toFixed(2)}/skein â€¢ ${Number(batch.totalCost).toFixed(2)} total
  </div>
)}

                                                {batch.profit != null && batch.profitMargin != null && (
  <div className={`text-xs font-medium mb-1 ${batch.profit >= 0 ? 'text-green-700' : 'text-red-700'}`}>
    ðŸ“ˆ Profit: ${Number(batch.profit).toFixed(2)} ({Number(batch.profitMargin).toFixed(1)}%)
  </div>
)}

                                                {batch.notes && (
                                                    <div className="text-xs text-gray-500 mb-2">{batch.notes}</div>
                                                )}
                                                
                                                <div className="flex gap-1 mt-2">
                                                    {statuses.map(s => {
                                                        if (s === batch.status) return null;
                                                        const targetStatus = statusLabels[s];
                                                        return (
                                                            <button
                                                                key={s}
                                                                onClick={() => updateStatus(batch.id, s, batch.status)}
                                                                className="text-xs px-2 py-1 bg-white border rounded hover:bg-gray-50"
                                                                title={`Move to ${targetStatus.label}`}
                                                            >
                                                                {targetStatus.emoji}
                                                            </button>
                                                        );
                                                    })}
                                                    <button
                                                        onClick={() => deleteBatch(batch.id)}
                                                        className="text-xs px-2 py-1 bg-white border rounded hover:bg-red-50 ml-auto"
                                                        title="Delete batch"
                                                    >
                                                        ðŸ—‘ï¸
                                                    </button>
                                                </div>
                                                </div>
                                            </div>
                                            );
                                        })}
                                        
                                        {batchesInStatus.length === 0 && (
                                            <div className="text-center py-8 text-gray-300 text-sm">
                                                No batches
                                            </div>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {batches.length === 0 && (
                        <div className="text-center py-12 text-gray-400">
                            <p className="text-xl mb-2">ðŸ”„</p>
                            <p>No batches in production yet. Start your first batch!</p>
                        </div>
                    )}
                </div>
            );
        }

        // Sales Component
        function Sales({ sales, saveSales, batches, saveBatches }) {
            const [showForm, setShowForm] = useState(false);
            const [formData, setFormData] = useState({
                batchId: '',
                colorway: '',
                customer: '',
                amount: '',
                date: new Date().toISOString().split('T')[0],
                platform: '',
                notes: ''
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                const newSale = { ...formData, id: Date.now() };
                saveSales([...sales, newSale]);
                
                // Mark batch as sold if selected
                if (formData.batchId) {
                    saveBatches(batches.map(b => 
                        b.id === parseInt(formData.batchId) ? { ...b, status: 'sold' } : b
                    ));
                }
                
                resetForm();
            };

            const resetForm = () => {
                setFormData({
                    batchId: '',
                    colorway: '',
                    customer: '',
                    amount: '',
                    date: new Date().toISOString().split('T')[0],
                    platform: '',
                    notes: ''
                });
                setShowForm(false);
            };

            const deleteSale = (id) => {
                if (confirm('Delete this sale?')) {
                    saveSales(sales.filter(s => s.id !== id));
                }
            };

            const readyBatches = batches.filter(b => b.status === 'ready');
            const totalRevenue = sales.reduce((sum, s) => sum + parseFloat(s.amount || 0), 0);
            const avgSale = sales.length > 0 ? totalRevenue / sales.length : 0;

            // Sales by month
            const salesByMonth = sales.reduce((acc, sale) => {
                const month = new Date(sale.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                acc[month] = (acc[month] || 0) + parseFloat(sale.amount || 0);
                return acc;
            }, {});

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-gray-900">Sales Tracking</h2>
                        <button
                            onClick={() => setShowForm(!showForm)}
                            className="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors font-medium"
                        >
                            {showForm ? 'âœ• Cancel' : '+ Record Sale'}
                        </button>
                    </div>

                    {/* Stats */}
                    <div className="grid md:grid-cols-3 gap-6">
                        <div className="bg-white rounded-lg card-shadow p-6">
                            <div className="text-sm text-gray-600 mb-1">Total Sales</div>
                            <div className="text-3xl font-bold text-gray-900">{sales.length}</div>
                        </div>
                        <div className="bg-white rounded-lg card-shadow p-6">
                            <div className="text-sm text-gray-600 mb-1">Total Revenue</div>
                            <div className="text-3xl font-bold text-green-600">${totalRevenue.toFixed(2)}</div>
                        </div>
                        <div className="bg-white rounded-lg card-shadow p-6">
                            <div className="text-sm text-gray-600 mb-1">Average Sale</div>
                            <div className="text-3xl font-bold text-purple-600">${avgSale.toFixed(2)}</div>
                        </div>
                    </div>

                    {/* Form */}
                    {showForm && (
                        <div className="bg-white rounded-lg card-shadow p-6">
                            <h3 className="text-xl font-semibold mb-4">Record New Sale</h3>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div className="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Link to Batch (Optional)</label>
                                        <select
                                            value={formData.batchId}
                                            onChange={(e) => {
                                                const batch = batches.find(b => b.id === parseInt(e.target.value));
                                                setFormData({ 
                                                    ...formData, 
                                                    batchId: e.target.value,
                                                    colorway: batch?.colorway || formData.colorway
                                                });
                                            }}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                        >
                                            <option value="">Select a ready batch</option>
                                            {readyBatches.map(b => (
                                                <option key={b.id} value={b.id}>
                                                    {b.colorway} ({b.skeins} skeins)
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Colorway Name *</label>
                                        <input
                                            type="text"
                                            required
                                            value={formData.colorway}
                                            onChange={(e) => setFormData({ ...formData, colorway: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                        />
                                    </div>
                                </div>

                                <div className="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Customer Name</label>
                                        <input
                                            type="text"
                                            value={formData.customer}
                                            onChange={(e) => setFormData({ ...formData, customer: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Platform</label>
                                        <input
                                            type="text"
                                            value={formData.platform}
                                            onChange={(e) => setFormData({ ...formData, platform: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                            placeholder="e.g., Etsy, Instagram, In-person"
                                        />
                                    </div>
                                </div>

                                <div className="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Sale Amount * ($)</label>
                                        <input
                                            type="number"
                                            step="0.01"
                                            required
                                            value={formData.amount}
                                            onChange={(e) => setFormData({ ...formData, amount: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Sale Date *</label>
                                        <input
                                            type="date"
                                            required
                                            value={formData.date}
                                            onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                                    <textarea
                                        value={formData.notes}
                                        onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                                        rows="2"
                                        className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                    />
                                </div>

                                <div className="flex gap-3 pt-4">
                                    <button
                                        type="submit"
                                        className="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors font-medium"
                                    >
                                        Record Sale
                                    </button>
                                    <button
                                        type="button"
                                        onClick={resetForm}
                                        className="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-300 transition-colors font-medium"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}

                    {/* Sales by Month */}
                    {Object.keys(salesByMonth).length > 0 && (
                        <div className="bg-white rounded-lg card-shadow p-6">
                            <h3 className="text-lg font-semibold mb-4">Revenue by Month</h3>
                            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                {Object.entries(salesByMonth).reverse().map(([month, amount]) => (
                                    <div key={month} className="text-center p-3 bg-purple-50 rounded-lg">
                                        <div className="text-sm text-gray-600 mb-1">{month}</div>
                                        <div className="text-lg font-bold text-purple-600">${amount.toFixed(2)}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Sales List */}
                    <div className="bg-white rounded-lg card-shadow overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-gray-50 border-b">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Colorway</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Platform</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {sales.slice().reverse().map(sale => (
                                        <tr key={sale.id} className="hover:bg-gray-50">
                                            <td className="px-6 py-4 text-sm">{new Date(sale.date).toLocaleDateString()}</td>
                                            <td className="px-6 py-4">
                                                <div className="font-medium">{sale.colorway}</div>
                                                {sale.notes && (
                                                    <div className="text-sm text-gray-500">{sale.notes}</div>
                                                )}
                                            </td>
                                            <td className="px-6 py-4 text-sm">{sale.customer || '-'}</td>
                                            <td className="px-6 py-4 text-sm">{sale.platform || '-'}</td>
                                            <td className="px-6 py-4 text-sm font-semibold text-green-600">${sale.amount}</td>
                                            <td className="px-6 py-4 text-right">
                                                <button
                                                    onClick={() => deleteSale(sale.id)}
                                                    className="text-red-600 hover:text-red-800"
                                                >
                                                    ðŸ—‘ï¸
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        {sales.length === 0 && (
                            <div className="text-center py-12 text-gray-400">
                                <p className="text-xl mb-2">ðŸ’°</p>
                                <p>No sales recorded yet. Record your first sale!</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Settings Component
        function Settings({ settings, saveSettings, inventory }) {
            const [activeSection, setActiveSection] = useState('colorTypes');
            const [newItem, setNewItem] = useState('');
            const [newMapping, setNewMapping] = useState({ supplierName: '', myName: '' });
            const [newSizeMapping, setNewSizeMapping] = useState({ grams: '', name: '' });

            const sections = {
                colorTypes: { label: 'Color Types', key: 'colorTypes' },
                inventoryCategories: { label: 'Inventory Categories', key: 'inventoryCategories' },
                units: { label: 'Measurement Units', key: 'units' },
                suppliers: { label: 'Suppliers', key: 'suppliers' },
                yarnBaseMappings: { label: 'Yarn Base Mappings', key: 'yarnBaseMappings' },
                sizeMappings: { label: 'Size Mappings', key: 'sizeMappings' }
            };

            const addItem = () => {
                if (!newItem.trim()) return;
                const currentList = settings[activeSection] || [];
                if (!currentList.includes(newItem.toLowerCase())) {
                    saveSettings({
                        ...settings,
                        [activeSection]: [...currentList, newItem.toLowerCase()]
                    });
                }
                setNewItem('');
            };

            const removeItem = (item) => {
                if (confirm(`Remove "${item}"?`)) {
                    saveSettings({
                        ...settings,
                        [activeSection]: settings[activeSection].filter(i => i !== item)
                    });
                }
            };

            const addYarnBaseMapping = () => {
                if (!newMapping.supplierName || !newMapping.myName) {
                    alert('Please fill in both supplier name and your name');
                    return;
                }
                const currentMappings = settings.yarnBaseMappings || [];
                saveSettings({
                    ...settings,
                    yarnBaseMappings: [...currentMappings, { ...newMapping }]
                });
                setNewMapping({ supplierName: '', myName: '' });
            };

            const removeYarnBaseMapping = (index) => {
                if (confirm('Remove this yarn base mapping?')) {
                    saveSettings({
                        ...settings,
                        yarnBaseMappings: settings.yarnBaseMappings.filter((_, i) => i !== index)
                    });
                }
            };


            const addSizeMapping = () => {
                if (!newSizeMapping.grams || !newSizeMapping.name) {
                    alert('Please fill in both grams and name');
                    return;
                }
                const currentMappings = settings.sizeMappings || [];
                saveSettings({
                    ...settings,
                    sizeMappings: [...currentMappings, { grams: parseFloat(newSizeMapping.grams), name: newSizeMapping.name }]
                });
                setNewSizeMapping({ grams: '', name: '' });
            };

            const removeSizeMapping = (index) => {
                if (confirm('Remove this size mapping?')) {
                    saveSettings({
                        ...settings,
                        sizeMappings: settings.sizeMappings.filter((_, i) => i !== index)
                    });
                }
            };

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold text-gray-900">Settings</h2>

                    <div className="bg-white rounded-lg card-shadow p-6">
                        <h3 className="text-lg font-semibold mb-4">Manage Dropdown Options</h3>
                        
                        {/* Section Tabs */}
                        <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
                            {Object.entries(sections).map(([key, section]) => (
                                <button
                                    key={key}
                                    onClick={() => setActiveSection(key)}
                                    className={`px-4 py-2 rounded-lg font-medium whitespace-nowrap ${
                                        activeSection === key 
                                            ? 'bg-purple-600 text-white' 
                                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                    }`}
                                >
                                    {section.label}
                                </button>
                            ))}
                        </div>

                        {/* Add New Item */}
                        {activeSection !== 'yarnBaseMappings' && activeSection !== 'sizeMappings' && (
                            <div className="mb-6">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Add New {sections[activeSection].label}
                                </label>
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={newItem}
                                        onChange={(e) => setNewItem(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && addItem()}
                                        className="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                        placeholder={`Enter new ${sections[activeSection].label.toLowerCase()}...`}
                                    />
                                    <button
                                        onClick={addItem}
                                        className="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors font-medium"
                                    >
                                        Add
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Yarn Base Mapping Form */}
                        {activeSection === 'yarnBaseMappings' && (
                            <div className="mb-6">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Add Yarn Base Mapping
                                </label>
                                <div className="grid md:grid-cols-2 gap-2 mb-2">
                                    <input
                                        type="text"
                                        value={newMapping.supplierName}
                                        onChange={(e) => setNewMapping({ ...newMapping, supplierName: e.target.value })}
                                        className="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                        placeholder="Supplier name (e.g., W2D4 SW DK)"
                                    />
                                    <input
                                        type="text"
                                        value={newMapping.myName}
                                        onChange={(e) => setNewMapping({ ...newMapping, myName: e.target.value })}
                                        className="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                        placeholder="Your name (e.g., Luna DK)"
                                    />
                                </div>
                                <button
                                    onClick={addYarnBaseMapping}
                                    className="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors font-medium"
                                >
                                    Add Mapping
                                </button>
                            </div>
                        )}


                        {/* Size Mapping Form */}
                        {activeSection === 'sizeMappings' && (
                            <div className="mb-6">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Add Size Mapping
                                </label>
                                <div className="grid md:grid-cols-2 gap-2 mb-2">
                                    <input
                                        type="number"
                                        value={newSizeMapping.grams}
                                        onChange={(e) => setNewSizeMapping({ ...newSizeMapping, grams: e.target.value })}
                                        className="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                        placeholder="Size in grams (e.g., 100)"
                                    />
                                    <input
                                        type="text"
                                        value={newSizeMapping.name}
                                        onChange={(e) => setNewSizeMapping({ ...newSizeMapping, name: e.target.value })}
                                        className="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                        placeholder="Display name (e.g., Full skein)"
                                    />
                                </div>
                                <button
                                    onClick={addSizeMapping}
                                    className="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors font-medium"
                                >
                                    Add Mapping
                                </button>
                            </div>
                        )}

                        {/* Current Items */}
                        {activeSection !== 'yarnBaseMappings' && activeSection !== 'sizeMappings' && (
                            <div>
                                <h4 className="font-medium text-gray-700 mb-3">
                                    Current {sections[activeSection].label}
                                </h4>
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                                    {(settings[activeSection] || []).map((item, idx) => (
                                        <div
                                            key={idx}
                                            className="flex items-center justify-between px-3 py-2 bg-gray-50 rounded-lg border"
                                        >
                                            <span className="capitalize text-sm">{item}</span>
                                            <button
                                                onClick={() => removeItem(item)}
                                                className="text-red-600 hover:text-red-800 ml-2"
                                            >
                                                âœ•
                                            </button>
                                        </div>
                                    ))}
                                </div>
                                {(settings[activeSection] || []).length === 0 && (
                                    <p className="text-gray-400 text-center py-8">No items yet</p>
                                )}
                            </div>
                        )}

                        {/* Yarn Base Mappings List */}
                        {activeSection === 'yarnBaseMappings' && (
                            <div>
                                <h4 className="font-medium text-gray-700 mb-3">Current Yarn Base Mappings</h4>
                                <div className="space-y-2">
                                    {(settings.yarnBaseMappings || []).map((mapping, idx) => (
                                        <div key={idx} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
                                            <div className="flex-1">
                                                <span className="font-medium">{mapping.supplierName}</span>
                                                <span className="mx-2">â†’</span>
                                                <span className="text-purple-600">{mapping.myName}</span>
                                            </div>
                                            <button
                                                onClick={() => removeYarnBaseMapping(idx)}
                                                className="text-red-600 hover:text-red-800 ml-2"
                                            >
                                                âœ•
                                            </button>
                                        </div>
                                    ))}
                                </div>
                                {(settings.yarnBaseMappings || []).length === 0 && (
                                    <p className="text-gray-400 text-center py-8">No mappings yet</p>
                                )}
                            </div>
                        )}


                        {/* Size Mappings List */}
                        {activeSection === 'sizeMappings' && (
                            <div>
                                <h4 className="font-medium text-gray-700 mb-3">Current Size Mappings</h4>
                                <div className="space-y-2">
                                    {(settings.sizeMappings || []).map((mapping, idx) => (
                                        <div key={idx} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
                                            <div className="flex-1">
                                                <span className="font-medium">{mapping.grams}g</span>
                                                <span className="mx-2">â†’</span>
                                                <span className="text-purple-600">{mapping.name}</span>
                                            </div>
                                            <button
                                                onClick={() => removeSizeMapping(idx)}
                                                className="text-red-600 hover:text-red-800 ml-2"
                                            >
                                                âœ•
                                            </button>
                                        </div>
                                    ))}
                                </div>
                                {(settings.sizeMappings || []).length === 0 && (
                                    <p className="text-gray-400 text-center py-8">No mappings yet</p>
                                )}
                            </div>
                        )}
                    </div>

                    {/* Export/Import Data */}
                    <div className="bg-white rounded-lg card-shadow p-6">
                        <h3 className="text-lg font-semibold mb-4">Data Management</h3>
                        <div className="space-y-3">
                            <button
                                onClick={() => {
                                    const data = {
                                        recipes: StorageManager.get('recipes'),
                                        inventory: StorageManager.get('inventory'),
                                        batches: StorageManager.get('batches'),
                                        sales: StorageManager.get('sales'),
                                        dyeSessions: StorageManager.get('dyeSessions'),
                                        kits: StorageManager.get('kits'),
                                        settings: StorageManager.get('settings')
                                    };
                                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = `yarn-dye-backup-${new Date().toISOString().split('T')[0]}.json`;
                                    a.click();
                                }}
                                className="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium"
                            >
                                ðŸ“¥ Export All Data (Backup)
                            </button>
                            <p className="text-sm text-gray-500">
                                Download all your recipes, inventory, batches, and sales data as a backup file.
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        // PASSWORD CONFIGURATION - Change this to your desired password
        const APP_PASSWORD = "dyestudio2026";

        // Password Screen Component
        function PasswordScreen({ onAuthenticated }) {
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (password === APP_PASSWORD) {
                    sessionStorage.setItem('dyestudio_auth', 'true');
                    onAuthenticated();
                } else {
                    setError('Incorrect password');
                    setPassword('');
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50">
                    <div style={{maxWidth: '28rem', width: '100%', padding: '1rem'}}>
                        <div className="bg-white rounded-lg card-shadow p-8">
                            <div className="text-center mb-8">
                                <h1 className="text-3xl font-bold text-gray-900 mb-2">ðŸ§¶ Celestial Dyeworks Studio</h1>
                                <p className="text-gray-600">Enter password to access</p>
                            </div>

                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Password
                                    </label>
                                    <input
                                        type="password"
                                        required
                                        value={password}
                                        onChange={(e) => {
                                            setPassword(e.target.value);
                                            setError('');
                                        }}
                                        className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                        placeholder="Enter password"
                                        autoFocus
                                    />
                                </div>

                                {error && (
                                    <div className="p-3 rounded-lg text-sm bg-red-50 text-red-700">
                                        {error}
                                    </div>
                                )}

                                <button
                                    type="submit"
                                    className="w-full bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors font-medium"
                                >
                                    Access App
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        // App Wrapper with Password Protection
        function App() {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const auth = sessionStorage.getItem('dyestudio_auth');
                if (auth === 'true') {
                    setIsAuthenticated(true);
                }
                setLoading(false);
            }, []);

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-50">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
                            <p className="text-gray-600">Loading...</p>
                        </div>
                    </div>
                );
            }

            if (!isAuthenticated) {
                return <PasswordScreen onAuthenticated={() => setIsAuthenticated(true)} />;
            }

            return <YarnDyeManager />;
        }

        // Render App
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
